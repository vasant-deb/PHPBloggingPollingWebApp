"use strict";!function(e){function t(e,t=!1){return x.storage(e,t)}function s(e){if(x.null(b))return e;let t=b.translations;return 0!=t&&e in t?""==t[e]?e:t[e]:e}function i(e){if(void 0===e)return window.sb_current_user;window.sb_current_user=e}var a,n,o,r,l,c,d,u,h,g,f,p,m,b,v=!1,_=document.title,y=e(window).width()<426,w=new Date;e.fn.extend({manualExpandTextarea:function(){var t=this[0];t.style.height="auto",t.style.maxHeight="25px",window.getComputedStyle(t),t.style.height=t.scrollHeight+"px",t.style.maxHeight="",e(t).trigger("textareaChanged")},autoExpandTextarea:function(){var t=this[0];t.addEventListener("input",function(s){e(t).manualExpandTextarea()},!1)}}),function(){var e=[].slice;String.prototype.autoLink=function(){var t,s,i,a,n,o,r;return o=/(^|[\s\n]|<[A-Za-z]*\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi,0<(n=1<=arguments.length?e.call(arguments,0):[]).length?(a=n[0],t=a.callback,i=function(){var e;for(s in e=[],a)r=a[s],"callback"!==s&&e.push(" "+s+"='"+r+"'");return e}().join(""),this.replace(o,function(e,s,a){return""+s+(("function"==typeof t?t(a):void 0)||"<a href='"+a+"'"+i+">"+a+"</a>")})):this.replace(o,"$1<a href='$2'>$2</a>")}}.call(this);var x={ajax:function(t,s=!1){"user_id"in t||0==i()||(t.user_id=i().id),"undefined"!=typeof SB_LANG&&(t.language=SB_LANG),e.ajax({method:"POST",url:SB_AJAX_URL,data:t}).done(e=>{let i;try{i=JSON.parse(e)}catch(s){console.log(e),x.error("Json parse error",`SBF.ajax.${t.function}`)}"success"==i[0]?0!=s&&s(i[1]):x.error(i[1],`SBF.ajax.${t.function}`)})},cors:function(e="GET",t,s){var i=new XMLHttpRequest;if("withCredentials"in i)i.open(e,t,!0);else{if("undefined"==typeof XDomainRequest)return!1;(i=new XDomainRequest).open(e,t)}i.onload=function(){s(i.responseText)},i.onerror=function(){return!1},i.send()},null:function(e){return void 0===e||null===e||"null"===e||!1===e||!(e.length>0||"number"==typeof e||void 0===e.length)||"undefined"===e},deactivateAll:function(){e(n).find(".sb-popup, .sb-tooltip, .sb-list .sb-menu, .sb-select ul").sbActivate(!1)},deselectAll:function(){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},getURL:function(e){return decodeURIComponent((new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20")||"")},restoreJson:function(e){return x.null(e)?"":e.replace(/\\n/g,"\n").replace(/\\r/g,"\r").replace(/\\t/g,"\t").replace(/\\f/g,"\f").replace(/\\'/g,"'").replace(/\\"/g,'"').replace(/\\\\/g,"\\")},stringToSlug:function(e){e=(e=e.trim()).toLowerCase();for(var t="åàáãäâèéëêìíïîòóöôùúüûñç·/_,:;",s=0,i=t.length;s<i;s++)e=e.replace(new RegExp(t.charAt(s),"g"),"aaaaaaeeeeiiiioooouuuunc------".charAt(s));return e.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-+/,"").replace(/-+$/,"").replace(/ /g," ")},slugToString:function(e){return(e=e.replace(/_/g," ")).charAt(0).toUpperCase()+e.slice(1)},random:function(){let e="";for(var t=5;t>0;--t)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return e},isAgent:function(e){return"agent"==e||"admin"==e||"bot"==e},beautifyTime:function(e){if("0000-00-00 00:00:00"==e)return"";let t=new Date(e.replace(" ","T")),i=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds())),a=Math.round((new Date-i)/864e5),n=[s("Sunday"),s("Monday"),s("Tuesday"),s("Wednesday"),s("Thursday"),s("Friday"),s("Saturday")];return a<1?i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):a<8?n[i.getDay()]:i.toLocaleDateString()},updateUsersActivity:function(e,t,s){x.ajax({function:"update-users-last-activity",user_id:e,return_user_id:t,check_slack:!r&&b["slack-active"]},e=>{s("online"===e?"online":"offline")})},search:function(e,t){(e=e.toLowerCase())!=l&&(clearTimeout(v),v=setTimeout(function(){l=e,t()},200))},searchClear:function(t,s){""!=e(t).next().val()&&(s(),e(t).next().val(""))},error:function(t,s){throw t instanceof Error&&(t=t.message),"."==t[t.length-1]&&(t=t.slice(0,-1)),t.indexOf("Support Board Error")>-1&&(t=t.replace("Support Board Error ","").replace("]:","]")),r&&x.dialog(`[Error] [${s}] ${t}. Check the console for more details.`,"info"),e(n).find(".sb-loading").sbLoading(!1),new Error(`Support Board Error [${s}]: ${t}.`)},login:function(n){if(!e(n).sbLoading()){let o=e(n).closest(".sb-rich-login"),l=e(o).find("#email input").val(),c=e(o).find("#password input").val();""==l||""==c?e(o).find(".sb-info").html(s("Please insert email and password.")).sbActivate():(x.ajax({function:"login",email:l,password:c},l=>{0!=l&&Array.isArray(l)?!r&&this.isAgent(l[0].user_type)?e(o).find(".sb-info").html(s("You can not sign in as agent.")).sbActivate():(t("login",l[1]),r?location.reload():(i(new C(l[0])),e(a).removeClass("sb-init-form-active"),e(o).remove(),A.initialized=!1,A.initChat())):e(o).find(".sb-info").html(s("Invalid email or password.")).sbActivate(),e(n).sbLoading(!1)}),e(o).find(".sb-info").html("").sbActivate(!1),e(n).sbLoading(!0))}},logout:function(){A.stopRealTime(),x.ajax({function:"logout"},()=>{t("login",""),location.reload()})},reset:function(){localStorage.removeItem("support-board"),this.logout()},dialog:function(e,t,s){r&&sbDialogAdmin(e,t,s)},lightbox:function(t){e(a).find(".sb-lightbox").sbActivate().find(" > div").html(t)},storage:function(e,t=!1){let s=localStorage.getItem("support-board");if(s=null===s?{}:JSON.parse(s),!1===t)return e in s&&s[e];""==t?delete s[e]:s[e]=t,localStorage.setItem("support-board",JSON.stringify(s))}};window.SBF=x,window.sb_current_user=!1,e.fn.sbActivate=function(t=!0){return t?e(this).addClass("sb-active"):e(this).removeClass("sb-active"),this},e.fn.sbActive=function(){return e(this).hasClass("sb-active")},e.fn.sbLoading=function(t="check"){return"check"==t?e(this).hasClass("sb-loading"):(1==t&&e(this).addClass("sb-loading"),0==t&&e(this).removeClass("sb-loading"),this)},e.fn.sbTogglePopup=function(t){var s=!0;return e(this).sbActive()?(e(this).sbActivate(!1),e(n).removeClass("sb-popup-active"),s=!1):(e(n).addClass("sb-popup-active"),e(n).find(".sb-popup").sbActivate(!1),e(this).css("left",e(t).offset().left+15).sbActivate(),x.deselectAll()),s},e.fn.sbUploadFiles=function(t){for(var s=e(this).prop("files"),i=0;i<s.length;i++){var a=s[i],n=new FormData;n.append("file",a),jQuery.ajax({url:SB_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:n,type:"POST",success:function(e){t(e)}})}e(this).value=""};class C{constructor(e={},t={}){this.details=e,this.extra=t,this.conversations=[]}get id(){return""==this.get("id")?this.get("user_id"):this.get("id")}get(e){return"full_name"==e?"first_name"in this.details?this.details.first_name+" "+this.details.last_name:"":e in this.details&&!x.null(this.details[e])?this.details[e]:""}getExtra(e){return e in this.extra&&!x.null(this.extra[e])?this.extra[e]:""}set(e,t){this.details[e]=t}setExtra(e,t){this.extra[e]=t}update(e){x.ajax({function:"get-user",user_id:this.id,extra:!0},t=>{for(var s=0;s<t.details.length;s++)this.setExtra(t.details[s].slug,t.details[s]);delete t.details,this.details=t,e()})}getConversations(e,t){x.ajax({function:"get-user-conversations",user_id:this.id,exclude_id:t},t=>{let s=[];for(var i=0;i<t.length;i++){let e=new $([new k(t[i])]);e.set("id",t[i].conversation_id),e.set("conversation_status_code",t[i].conversation_status_code),s.push(e)}this.conversations=s,e(s)})}getConversationsCode(e=!1){let t="";0==e&&(e=this.conversations);for(var i=0;i<e.length;i++)e[i]instanceof $?t+=`<li data-conversation-status="${e[i].get("conversation_status_code")}" data-conversation-id="${e[i].id}">${e[i].getCode()}</li>`:x.error("Conversation not of type SBConversation","SBUser.getConversationsCode");return""==t&&(t=`<p class="sb-no-results">${s("No conversations found.")}</p>`),t}getFullConversation(e,t){x.ajax({function:"get-conversation",conversation_id:e},e=>{let s=[];for(var i=0;i<e.messages.length;i++)s.push(new k(e.messages[i]));t(new $(s,e.details))})}addConversation(e){if(e instanceof $){let s=e.id,i=!0;for(var t=0;t<this.conversations.length;t++)if(this.conversations[t].id==s){this.conversations[t]=e,i=!1;break}i&&this.conversations.unshift(e)}else x.error("Conversation not of type SBConversation","SBUser.addConversation")}isConversationsEmpty(){return 0==this.conversations.length}isExtraEmpty(){return 0===Object.keys(this.extra).length&&this.extra.constructor===Object}delete(t){x.ajax({function:"delete-user",user_id:this.id},s=>(e(document).trigger("SBUserDeleted",this.id),t(),!0))}}window.SBUser=C;class k{constructor(e){this.details=e,"first_name"in this.details&&(this.details.full_name=this.details.first_name+" "+this.details.last_name),this.set("payload",""!=this.get("payload")?JSON.parse(this.get("payload")):{})}get id(){return this.get("id")}get(e){return e in this.details&&!x.null(this.details[e])?this.details[e]:""}set(e,t){this.details[e]=t}payload(e=!1){if(!1!==e){let t=this.get("payload");t[key]=e,this.set("payload",t)}return this.get("payload")}getCode(){let e=x.isAgent(this.details.user_type),t=r&&e?`<i class="sb-menu-btn sb-icon-menu"></i><ul class="sb-menu">${b["dialogflow-active"]?`<li data-value="bot">${s("Send to Dialogflow")}</li>`:""}<li data-value="delete">${s("Delete")}</li></ul>`:"",i=this.render(this.details.message),a=x.null(this.details.attachments)?[]:JSON.parse(this.details.attachments),n="",o="",l=r||e&&!b["hide-agents-thumb"]||!e&&b["display-users-thumb"]?`<div class="sb-thumb"><img src="${this.details.profile_image}"><div>${this.details.full_name}</div></div>`:"",c=(e?"":"sb-right")+(""==l?"":" sb-thumb-active");if(""==i&&0==a.length)return"";if(e){let e=i.match(/\[.+?\]/g)||[],t=!1;for(d=0;d<e.length;d++){let s=j.shortcode(e[d]),a=j.generate(s[1],s[0]);0!=a&&("["!=i.charAt(0)&&(a=a.replace("sb-rich-message","sb-rich-message sb-margin-top")),"]"!=i.charAt(i.length-1)&&(a=a.replace("sb-rich-message","sb-rich-message sb-margin-bottom")),i=i.replace(e[d],a),t=!0)}t&&(c+=" sb-rich-cnt")}if(a.length){n='<div class="sb-message-attachments">';for(var d=0;d<a.length;d++)/.jpg|.png|.gif/.test(a[d][1])?o+=`<div class="sb-image"><img src="${a[d][1]}" /></div>`:n+=`<a rel="noopener" target="_blank" href="${a[d][1]}">${a[d][0]}</a>`;n+="</div>"}return`<div data-id="${this.details.id}" class="${c}">${l}<div class="sb-cnt"><div class="sb-message${""!=o&&""==i?" sb-message-media":""}">${i}${o}</div>${n}<div class="sb-time">${x.beautifyTime(this.details.creation_time)}</div></div>${t}</div>`}render(t=!1){let s=t.length;!1===t&&(t=""+this.details.message);let i=t.match(/```([\s\S]*)```/)||[];for(a=0;a<i.length;a++)t=t.replace(i[a],"[code-"+a+"]");t=(t=(t=(t=(t=(t=(t=t.replace(/(?:\r\n|\r|\n)/g,"<br>")).replace(/\*([^\**]+)\*/g,"<b>$1</b>")).replace(/\_([^\__]+)\_/g,"<i>$1</i>")).replace(/\_([^\__]+)\_/g,"<i>$1</i>")).replace(/\~([^\~~]+)\~/g,"<del>$1</del>")).replace(/\`([^\``]+)\`/g,"<code>$1</code>")).replace(/u([0-9a-f]{4,5})/im,"&#x$1;"),((6==s||5==s)&&t.startsWith("&#x")||s<3&&t.match(/(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|\ud83c[\ude32-\ude3a]|\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/))&&(t=`<span class="emoji-large">${t}</span>`),t.indexOf("http")>-1&&(t=t.autoLink({target:"_blank"}));for(var a=0;a<i.length;a++)t=t.replace("[code-"+a+"]","<pre>"+e.trim(e.trim(i[a]).substr(3,i[a].length-6).replace(/(?:\r\n|\r|\n)/g,"<br>")))+"</pre>";return t}}window.SBMessage=k;class ${constructor(e,t){this.details=x.null(t)?{}:t,Array.isArray(e)?(this.messages=[],e.length&&(e[0]instanceof k?this.messages=e:x.error("Messages not of type SBMessages","SBConversation.constructor"))):x.error("Message array not of type Array","SBConversation.constructor")}get id(){return this.get("id")}get(e){if(e in this.details&&!x.null(this.details[e]))return this.details[e];if("title"==e){if(!x.null(this.details.first_name))return this.details.first_name+" "+this.details.last_name;if(this.messages.length)return this.messages[0].get("full_name")}return""}set(e,t){this.details[e]=t}getMessage(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t].id==e)return this.messages[t];return!1}updateMessage(e,t){for(var s=0;s<this.messages.length;s++)if(this.messages[s].id==e)return this.messages[s]=t,!0;return!1}deleteMessage(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t].id==e)return this.messages.splice(t,1),!0;return!1}getLastMessage(){let e=this.messages.length;return e>0&&this.messages[e-1]}addMessages(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)e[t]instanceof k&&this.messages.push(e[t]);else e instanceof k?this.messages.push(e):x.error("Messages not of type SBMessages","SBConversation.addMessages()")}getCode(){if(this.messages.length){let e=this.messages[0].get("message");return e.length>114&&(e=e.substr(0,114)+" ..."),`<div class="sb-conversation-item" data-user-id="${this.messages[0].get("user_id")}"><img src="${this.messages[0].get("profile_image")}"><div><span class="sb-name">${this.messages[0].get("full_name")}</span><span class="sb-time">${x.beautifyTime(this.messages[0].get("creation_time"))}</span></div><div class="sb-message">${e}</div></div>`}return""}}window.SBConversation=$;var A={replies_list:[],rich_messages_list:["buttons","select","inputs","table","list"],emoji_options:{range:0,range_limit:48,list:[],list_now:[],touch:!1},initialized:!1,editor_listening:!1,conversation:!1,is_busy:!1,chat_open:!1,real_time:!1,agent_id:-1,agent_online:!1,user_online:!1,expanded:!1,main_header:!0,start_header:!1,desktop_notifications:!1,flash_notifications:!1,datetime_last_message:"2000-01-01 00:00:00",datetime_last_message_conversation:"2000-01-01 00:00:00",audio:!1,tab_active:!0,notifications:[],typing_settings:{typing:!1,sent:!1,timeout:!1},email_sent:!1,dialogflow_token:0==t("dialogflow-token")?-1:t("dialogflow-token"),timetable:!0,dashboard:!1,articles:!1,slack_channel:[-1,-1],skip:!1,sendMessage:function(s=-1,a="",n=[]){if(0!=A.conversation){if(-1==s&&(s=r?SB_CURRENT_AGENT.id:i().id),""==a&&0==n.length&&(e(d).find(".sb-attachments > div").each(function(){n.push([e(this).attr("data-name"),e(this).attr("data-url")])}),a=e(u).val().trim()),""!=a||n.length){let o=0!=this.conversation.getLastMessage()?r?1:2:-1,l=s!=b["bot-id"];this.busy(!0),l&&(e(u).val("").css("height",""),e(d).find(".sb-attachments").html("")),x.ajax({function:"send-message",user_id:s,conversation_id:this.conversation.id,message:a,attachments:n,conversation_status:o},c=>{(r&&!this.user_online||!r&&!this.agent_online)&&this.update(),!r&&this.dashboard&&s==b["bot-id"]&&this.updateConversations(),!r&&l&&b.follow&&w.getDate()!=t("email")&&this.followUp(),!this.email_sent&&l&&(!r&&b["notify-agent-email"]||r&&b["notify-user-email"]&&""!=i().get("email"))&&x.ajax({function:"create-email",recipient_id:r?i().id:0!=this.lastAgent(!1)?this.lastAgent(!1).user_id:-1,sender_name:r?SB_CURRENT_AGENT.full_name:i().get("full_name"),sender_profile_image:r?SB_CURRENT_AGENT.profile_image:i().get("profile_image"),message:a,attachments:n},()=>{this.email_sent=!0}),!0===c&&(l&&this.sendBotMessage(a),!r&&l&&"visitor"==i().get("user_type")?x.ajax({function:"update-user-to-lead",user_id:s},()=>{i().set("user_type","lead"),b["slack-active"]&&this.slackMessage(s,i().get("full_name"),i().get("profile_image"),a,n)}):b["slack-active"]&&!this.skip&&this.slackMessage(i().id,l?i().get("full_name"):b["bot-name"],l?i().get("profile_image"):b["bot-image"],a,n),this.timetable&&l&&!r&&b.timetable&&!b["office-hours"]&&setTimeout(()=>{0!=this.conversation&&(this.sendMessage(b["bot-id"],"[timetable]"),this.scrollBottom(),this.timetable=!1)},5e3),!this.articles||r||!b.articles||b["office-hours"]||this.isInitDashboard()||setTimeout(()=>{0!=this.conversation&&(this.sendMessage(b["bot-id"],"[articles]"),this.scrollBottom(),this.articles=!1)},5e3)),e(document).trigger("SBMessageSent",{conversation_id:this.conversation.id,conversation_status:o,message:a,attachments:n}),this.skip&&(this.skip=!1),this.busy(!1)})}}else A.newConversation(r?1:2,s,a,n)},sendBotMessage:function(e){!b["dialogflow-active"]||r||b["bot-office-hours"]&&b["office-hours"]||setTimeout(()=>{x.ajax({function:"send-bot-message",conversation_id:this.conversation.id,message:e,token:this.dialogflow_token},e=>{if("success-bot"==e.status&&(this.dialogflow_token!=e.token&&(this.dialogflow_token=e.token,t("dialogflow-token",e.token)),b["slack-active"]&&"messages"in e&&Array.isArray(e.messages)))for(var s=0;s<e.messages.length;s++)this.slackMessage(i().id,b["bot-name"],b["bot-image"],e.messages[s].message,e.messages[s].attachments)})},b["bot-delay"])},initChat:function(){r||!b.popup||t("popup")||this.popup(),r||!b.privacy||b["registration-required"]||t("privacy-approved")?("undefined"!=typeof Notification&&("all"==b["desktop-notifications"]||!r&&"users"==b["desktop-notifications"]||r&&"agents"==b["desktop-notifications"])&&(this.desktop_notifications=!0),("all"==b["flash-notifications"]||!r&&"users"==b["flash-notifications"]||r&&"agents"==b["flash-notifications"])&&(this.flash_notifications=!0),function(e=!1,s){x.ajax({function:"get-active-user",storage:t("login"),db:e,login_app:T.login()},e=>{if(!e)return s(),!1;if("user_type"in e)if(!r&&x.isAgent(e.user_type)){let e="You are logged in as both agent and user. Logout or use another browser, Incognito Mode to login as user. You can force a logout by execute the function SBF.reset() in the console.";t("double-lougin-alert")||(t("double-lougin-alert",!0),alert(e)),console.warn("Support Board: "+e)}else i(new C(e)),s()})}(!0,()=>{let t=!1!==i(),a=!!t&&i().get("user_type");!b["registration-required"]||t&&"visitor"!=a&&"lead"!=a?(!b["visitors-registration"]&&!b.welcome||t?0==this.conversation&&t?this.populateConversations():this.finalizeInit():this.addUserAndLogin(()=>{this.welcome(),this.finalizeInit()}),b["header-name"]&&t&&"user"==a&&e(h).find(".sb-title").html(`${s("Hello")} ${i().get("full_name")}!`),t&&this.welcome(),setInterval(()=>{this.updateConversations(),this.updateUsersActivity()},1e4),this.scrollBottom(!0)):this.registration()})):this.privacy()},finalizeInit:function(){this.initialized||(e(a).attr("style",""),x.ajax({function:"current-url",url:window.location.href}),r||(this.isInitDashboard()&&this.showDashboard(),!y&&window.innerHeight<760&&e(a).find(" > .sb-body").css("max-height",window.innerHeight-130+"px")),this.initialized=!0)},openChat:function(){this.initialized&&(this.populate(),this.headerAgent(),this.updateUsersActivity(),this.startRealTime(),this.chat_open=!0,this.popup("close"),0!=this.conversation&&0!=this.conversation.get("conversation_status_code")&&this.updateNotifications("remove",this.conversation.id),e(a).sbActivate(),e("body").addClass("sb-chat-open"))},openButton:function(){this.chat_open=e(a).sbActive(),this.chat_open?(e(a).sbActivate(!1),this.stopRealTime(),this.chat_open=!1,e("body").removeClass("sb-chat-open")):this.openChat()},openConversation:function(e){i().getFullConversation(e,t=>{this.setConversation(t),this.populate(),this.hideDashboard(),this.main_header=!1,this.chat_open&&0!=t.get("conversation_status_code")&&this.updateNotifications("remove",e)})},update:function(){if(0!=this.conversation){let t=this.conversation.getLastMessage();x.ajax({function:"get-new-messages",conversation_id:this.conversation.id,datetime:this.datetime_last_message_conversation},i=>{if(0!=this.conversation&&Array.isArray(i)&&i.length>0&&(!t||t.id!=i[0].id||t.get("message")!=i[0].message)){let t="",n=[];for(var a=0;a<i.length;a++){let s=new k(i[a]);if(this.datetime_last_message_conversation=s.get("creation_time"),"boolean"!=typeof s.payload()&&"event"in s.payload()&&"delete-message"==s.payload().event){!1!==this.conversation.getMessage(s.id)&&this.deleteMessage(s.id);break}0==this.conversation.getMessage(i[a].id)?(this.conversation.addMessages(s),t+=s.getCode()):(this.conversation.updateMessage(s.id,s),e(c).find(`[data-id="${s.id}"]`).replaceWith(s.getCode())),n.push(s)}e(c).append(t);let o=this.conversation.getLastMessage(),l=o.get("user_type");!r&&this.chat_open&&x.isAgent(l)&&"bot"!=l&&(-1==o.get("message").indexOf("sb-rich-success")&&this.setConversationStatus(0),b.follow&&clearTimeout(v),b["dialogflow-active"]=!1),this.headerAgent(),this.dashboard||this.scrollBottom(),setTimeout(function(){e(g).removeClass("sb-status-typing").addClass("sb-status-online").html(s("Online"))},500),e(document).trigger("SBChatNewMessages",{messages:n})}})}},updateConversations:function(){0!=i()&&x.ajax({function:"get-new-user-conversations",datetime:this.datetime_last_message},t=>{if(t.length){this.datetime_last_message=t[0].creation_time;for(var n=0;n<t.length;n++){let e=t[n].conversation_id,a=new k(t[n]),o=x.isAgent(t[n].user_type)?1:0,r=new $([a],{id:e,conversation_status_code:o});if(i().addConversation(r),0==this.conversation&&(this.conversation=r),this.conversation.set("conversation_status_code",o),t[n].user_id==i().id||0!=this.conversation&&this.conversation.id==e&&this.chat_open||(this.updateNotifications("add",e),b["auto-open"]&&this.openChat()),!this.tab_active){if(this.desktop_notifications)if("granted"!==Notification.permission)Notification.requestPermission();else{new Notification(a.get("full_name"),{body:a.get("message"),icon:a.get("profile_image")}).onclick=(()=>{A.openChat(),window.focus()})}this.flash_notifications&&(document.title=s("New message ..."))}}!b["chat-sound"]||this.chat_open&&this.tab_active||this.audio.play(),e(a).find(".sb-user-conversations").html(i().getConversationsCode())}})},populate:function(){if(0!=this.conversation){let s="";for(var t=0;t<this.conversation.messages.length;t++)s+=this.conversation.messages[t].getCode();e(c).html(s),this.scrollBottom(),e(document).trigger("SBChatPopulateComplete",this.conversation)}else 0==i()||i().isConversationsEmpty()||this.showDashboard()},populateConversations:function(){0!=i()&&i().getConversations(t=>{let s=t.length;if(s){this.datetime_last_message=t[0].messages[0].get("creation_time");for(var n=0;n<s;n++)1==t[n].get("conversation_status_code")&&this.updateNotifications("add",t[n].id);e(a).removeClass("sb-no-conversations"),e(a).find(".sb-user-conversations").html(i().getConversationsCode())}this.initialized||1!=s||this.isInitDashboard()||this.openConversation(i().conversations[0].id),this.finalizeInit()})},newConversation:function(t,s=-1,a="",n=[]){0!=i()?x.ajax({function:"new-conversation",status_code:t},i=>{if("user-not-found"==i)return void this.addUserAndLogin(()=>{this.newConversation(t,s,a,n)});let o=new $([],i.details);this.setConversation(o),this.sendMessage(s,a,n),e(document).trigger("SBChatNewConversationCreated",o)}):x.error("currentUser() not setted","SBChat.newConversation")},setConversation:function(e){e instanceof $?(this.conversation=e,this.datetime_last_message_conversation=0==this.conversation.getLastMessage()?"2000-01-01 00:00:00":this.conversation.getLastMessage().get("creation_time")):x.error("Value not of type SBConversation","SBChat.setConversation")},startRealTime:function(){this.stopRealTime(),this.real_time=setInterval(()=>{(!r||r&&this.user_online)&&this.update(),this.typing(r?0!=i()?i().id:-1:this.agent_id,"check")},1e3)},stopRealTime:function(){clearInterval(this.real_time)},updateUsersActivity:function(){0!=i()&&x.updateUsersActivity(i().id,this.agent_id,t=>{this.typing_settings.typing||("online"==t||this.agent_id==b["bot-id"]?(e(g).addClass("sb-status-online").html(s("Online")),this.agent_online=!0):(e(g).removeClass("sb-status-online").html(s("Away")),this.agent_online=!1))})},busy:function(t){e(d).find(".sb-loader").sbActivate(t),this.is_busy=t},initEditorBoxes:function(){x.ajax({function:"saved-replies"},t=>{if(Array.isArray(t)){let a="";if(t.length>0&&""!=t[0]["reply-name"]){this.replies_list=t;for(var i=0;i<t.length;i++)a+=`<li><div>${t[i]["reply-name"]}</div><div>${t[i]["reply-text"]}</div></li>`}else a=`<p class="sb-no-results">${s("No saved replies found. Add new replies from the Settings area.")}</p>`;e(f).find(".sb-replies-list > ul").html(a)}})},headerAgent:function(){if(!r&&!this.dashboard&&0!=this.conversation&&(-1==this.agent_id||x.isAgent(this.conversation.getLastMessage().get("user_type"))&&this.conversation.getLastMessage().get("user_id")!=this.agent_id)){let t=this.lastAgent();0!=t&&(this.agent_id=t.user_id,0==this.start_header&&(this.start_header=[e(h).html(),e(h).attr("class")]),e(h).addClass("sb-header-agent").removeClass("sb-header-main sb-header-brand").attr("data-agent-id",this.agent_id).html(`<div class="sb-dashboard-btn sb-icon-arrow-left"></div><div class="sb-profile"><img src="${t.profile_image}" /><div><span class="sb-name">${t.full_name}</span><span class="sb-status">${s("Away")}</span></div></div>`),g=e(h).find(".sb-status"),this.main_header=!1,this.updateUsersActivity())}},lastAgent:function(e=!0){let t=!1;if(0!=this.conversation)for(var s=this.conversation.messages.length-1;s>-1;s--){let i=this.conversation.messages[s].get("user_type");if(x.isAgent(i)&&(e||!e&&"bot"!=i)){t={user_id:this.conversation.messages[s].get("user_id"),full_name:this.conversation.messages[s].get("full_name"),profile_image:this.conversation.messages[s].get("profile_image")};break}}return t},scrollBottom:function(t=!1){setTimeout(()=>{e(m).scrollTop(t?0:e(m)[0].scrollHeight),this.scrollHeader()},20)},scrollHeader:function(){if(this.main_header&&this.dashboard){let t=e(m).scrollTop();t>-1&&t<1e3&&e(h).find(".sb-content").css({opacity:1-t/500,top:t/10*-1+"px"})}},showDashboard:function(){r||(e(a).addClass("sb-dashboard-active"),e(h).removeClass("sb-header-agent sb-header-panel"),0!=this.start_header&&e(h).html(this.start_header[0]).addClass(this.start_header[1]),e(m).find(" > div").sbActivate(!1),e(a).find(".sb-dashboard").sbActivate(),this.populateConversations(),this.conversation=!1,this.agent_id=-1,this.stopRealTime(),this.dashboard=!0,this.main_header=!0,this.scrollBottom(!0))},hideDashboard:function(){r||(e(c).sbActivate(),e(a).removeClass("sb-dashboard-active").find(".sb-dashboard").sbActivate(!1),this.dashboard=!1,this.headerAgent(),this.scrollHeader(0),this.chat_open&&this.startRealTime())},showPanel:function(t,i){let a=e(m).find(" > .sb-panel-"+t);a.length&&(e(m).find(" > div").sbActivate(!1),e(a).sbActivate(),0==this.start_header&&(this.start_header=[e(h).html(),e(h).attr("class")]),e(h).attr("class","sb-header sb-header-panel").html(`${s(i)}<div class="sb-dashboard-btn sb-icon-close"></div>`),this.dashboard=!0)},clear:function(){this.conversation=!1,e(c).html("")},updateNotifications:function(t="add",s){if("add"!=t||this.notifications.includes(s)||this.notifications.push(s),"remove"==t)for(var i=0;i<this.notifications.length;i++)if(this.notifications[i]==s){this.notifications.splice(i,1),this.setConversationStatus(0);break}let n=this.notifications.length;e(a).find(".sb-chat-btn span").attr("data-count",n).html(n>-1?n:0)},setConversationStatus:function(e){x.ajax({function:"update-conversation-status",conversation_id:this.conversation.id,status:e},()=>{this.conversation.set("conversation_status_code",e)})},typing:function(t,i="check"){0!=this.conversation&&("check"==i&&-1!=t&&t!=b["bot-id"]&&(this.agent_online||r&&this.user_online)&&x.ajax({function:"is-typing",user_id:t,conversation_id:this.conversation.id},t=>{t&&!this.typing_settings.typing?(r||e(g).addClass("sb-status-typing").html(s("Typing")),this.typing_settings.typing=!0,e(document).trigger("SBTyping",!0)):!t&&this.typing_settings.typing&&(r||e(g).removeClass("sb-status-typing").addClass("sb-status-online").html(s("Online")),this.typing_settings.typing=!1,e(document).trigger("SBTyping",!1))}),"set"==i&&(this.typing_settings.sent?(clearTimeout(this.typing_settings.timeout),this.typing_settings.timeout=setTimeout(()=>{x.ajax({function:"set-typing",user_id:t,conversation_id:-1},()=>{this.typing_settings.sent=!1})},2e3)):(this.typing_settings.sent=!0,x.ajax({function:"set-typing",user_id:t,conversation_id:this.conversation.id}),this.typing(t,"set"))))},showArticles:function(t=-1){let i=e(m).find(" > .sb-panel-articles"),a="";e(i).html("").sbLoading(!0),this.showPanel("articles",""==b["articles-title"]?"Help Center":b["articles-title"]),this.getArticles(t,n=>{if(-1==t){for(var o=0;o<n.length;o++)a+=`<div data-id="${n[o].id}"><div>${n[o].title}</div><span>${n[o].content}</span></div>`;e(i).html(`<div class="sb-articles">${a}</div>`)}else!1!==n&&e(i).html(`<div data-id="${n.id}" class="sb-article"><div class="sb-title">${n.title}</div><div class="sb-content">${n.content.replace(/(?:\r\n|\r|\n)/g,"<br>")}</div>${""==n.link?"":`<a href="${n.link}" target="_blank" class="sb-btn-text"><i class="sb-icon-plane"></i>${s("Read more")}</a>`}</div>`);e(i).sbLoading(!1)})},getArticles:function(e=-1,t=!1){if(!1===this.articles||-1!=e)x.ajax({function:"get-articles",id:e},s=>{if(-1==e&&(this.articles=s),!1===t)return s;t(s)});else{if(!1===t)return this.articles;t(this.articles)}},searchArticles:function(t,i){""!=t&&(e(i).sbLoading(!0),x.ajax({function:"search-articles",search:t},t=>{let n="";if(0==t.length)n+=`<p class="sb-no-results">${s("No articles found.")}</p>`;else for(var o=0;o<t.length;o++)n+=`<div data-id="${t[o].id}"><div>${t[o].title}</div><span>${t[o].content}</span></div>`;e(a).find(".sb-dashboard-articles .sb-articles").html(n),e(i).sbLoading(!1)}))},categoryEmoji:function(e){let t=this.emoji_options.list;if("all"==e)this.emoji_options.list_now=t;else{this.emoji_options.list_now=[];for(var s=0;s<t.length;s++)t[s].category.startsWith(e)&&this.emoji_options.list_now.push(t[s])}this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()},mouseWheelEmoji:function(t){let s=this.emoji_options.range;(function(e){let t=e.originalEvent.wheelDelta;return void 0===t&&(t=e.originalEvent.deltaY),void 0===t&&(t=e.originalEvent.detail),t})(t)>0||y&&void 0!==t.originalEvent.changedTouches&&this.emoji_options.touch<t.originalEvent.changedTouches[0].clientY?s-=s<1?0:1:s+=s>this.emoji_options.range_limit?0:1,e(p).find(".sb-emoji-bar > div").sbActivate(!1).eq(s).sbActivate(),this.emoji_options.range=s,this.populateEmoji(s),t.preventDefault()},insertEmoji:function(t){t.indexOf(".svg")>0&&(t=e.parseHTML(t)[0].alt),this.insertText(t),e(p).sbTogglePopup()},showEmoji:function(t){e(p).sbTogglePopup(t)&&(r||e(p).css({left:e(d).offset().left+20,top:e(d).offset().top-window.scrollY-375}),""==e(p).find(".sb-emoji-list > ul").html()&&jQuery.ajax({method:"POST",url:SB_AJAX_URL,data:{function:"emoji"}}).done(e=>{this.emoji_options.list=JSON.parse(e),this.emoji_options.list_now=this.emoji_options.list,this.populateEmoji(0),this.populateEmojiBar()}),x.deselectAll())},populateEmoji:function(t){let s="",i=y?42:49,a=t*i+i,n=this.emoji_options.list_now;a>n.length&&(a=n.length),this.emoji_options.range_limit=n.length/i-1,this.emoji_options.range=t;for(var o=t*i;o<a;o++)s+=`<li>${n[o].char}</li>`;e(p).find(".sb-emoji-list").html(`<ul>${s}</ul>`)},populateEmojiBar:function(){let t='<div class="sb-active"></div>',s=y?42:49;for(var i=0;i<this.emoji_options.list_now.length/s-1;i++)t+="<div></div>";this.emoji_options.range=0,e(p).find(".sb-emoji-bar").html(t)},clickEmojiBar:function(t){let s=e(t).index();this.populateEmoji(s),this.emoji_options.range=s,e(p).find(".sb-emoji-bar > div").sbActivate(!1).eq(s).sbActivate()},searchEmoji:function(e){x.search(e,()=>{if(e.length>1){let s=this.emoji_options.list,i=[];for(var t=0;t<s.length;t++)(s[t].category.toLowerCase().indexOf(e)>-1||s[t].name.toLowerCase().indexOf(e)>-1)&&i.push(s[t]);this.emoji_options.list_now=i}else this.emoji_options.list_now=this.emoji_options.list;this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()})},insertContent:function(t){this.insertText(t),x.deactivateAll(),e(n).removeClass("sb-popup-active")},showBox:function(t){e(f).sbTogglePopup(t),x.deselectAll()},searchReplies:function(t){x.search(t,()=>{let s="",i=!(t.length>1);for(var a=0;a<this.replies_list.length;a++)(i||this.replies_list[a]["reply-name"].toLowerCase().indexOf(t)>-1||this.replies_list[a]["reply-text"].toLowerCase().indexOf(t)>-1)&&(s+=`<li><div>${this.replies_list[a]["reply-name"]}</div><div>${this.replies_list[a]["reply-text"]}</div></li>`);e(f).find(".sb-replies-list > ul").html(s)})},textareaChange:function(t){let s=e(t).val(),a=s.charAt(t.selectionStart-1);if("#"==a&&(this.editor_listening=!0),this.editor_listening&&" "==a){let i=s.substr(s.lastIndexOf("#")+1).replace(" ","");this.editor_listening=!1;for(var n=0;n<this.replies_list.length;n++)if(this.replies_list[n]["reply-name"]==i)return void e(t).val(s.substr(0,s.lastIndexOf("#"))+this.replies_list[n]["reply-text"])}""!=s?(this.typing(r?SB_CURRENT_AGENT.id:i().id,"set"),this.activateBar()):this.activateBar(!1)},insertText:function(t){let s=e(u).get(0),i=0;if("selectionStart"in s)i=s.selectionStart;else if("selection"in document){s.focus();let e=document.selection.createRange();var a=document.selection.createRange().text.length;e.moveStart("character",-s.value.length),i=e.text.length-a}e(s).val(e(s).val().substr(0,i)+t+e(s).val().substr(i)),e(s).focus(),e(s).manualExpandTextarea(),this.activateBar()},enabledAutoExpand:function(){e(u).autoExpandTextarea()},privacy:function(){x.ajax({function:"get-block-setting",value:"privacy"},t=>{e(m).append(`<div class="sb-privacy sb-init-form" data-decline="${t.decline.replace(/"/g,"")}"><div class="sb-title">${t.title}</div><div class="sb-text">${t.message}</div>`+(""!=t.link?`<a target="_blank" href="${t.link}">${t.link.replace("http://","").replace("https://","").replace("www.","")}</a>`:"")+`<div class="sb-buttons"><a class="sb-btn sb-approve">${t["btn-approve"]}</a><a class="sb-btn sb-decline">${t["btn-decline"]}</a></div></div>`),this.finalizeInit()}),this.dashboard=!0,e(a).addClass("sb-init-form-active")},popup:function(i=""){"close"!=i?this.chat_open||x.ajax({function:"get-block-setting",value:"popup"},t=>{setTimeout(()=>{this.chat_open||e(a).append('<div class="sb-popup-message">'+(""!=t.image?`<img src="${t.image}" />`:"")+(""!=t.title?`<div class="sb-top">${s(t.title)}</div>`:"")+`<div class="sb-text">${s(t.message)}</div><div class="sb-icon-close"></div></div>`)},1e3)}):e(a).find(".sb-popup-message").length&&(t("popup",!0),e(a).find(".sb-popup-message").remove())},followUp:function(){r||0==i()||""!=i().get("email")||(0!=v&&clearTimeout(v),v=setTimeout(()=>{0!=this.conversation&&(this.sendMessage(b["bot-id"],"[email]"),this.scrollBottom(),t("email",w.getDate()))},15e3))},welcome:function(){b.welcome&&!t("welcome")&&0!=i()&&x.ajax({function:"get-block-setting",value:"welcome"},e=>{setTimeout(()=>{!1===this.conversation?this.newConversation(3,b["bot-id"],s(e.message)):this.sendMessage(b["bot-id"],s(e.message)),e.open&&this.openChat(),e.sound&&this.audio.play(),this.skip=!0},2e3),t("welcome",!0)})},slackMessage:function(e,t,s,a,n=[]){let o=this.conversation.id;x.ajax({function:"send-slack-message",user_id:e,full_name:t,profile_image:s,conversation_id:o,message:a,attachments:n,channel:this.slack_channel[0]==i().id?this.slack_channel[1]:-1},e=>{Array.isArray(e)&&"success"==e[0]?this.slack_channel=[i().id,e[1]]:x.error(JSON.stringify(e),"send-slack-message")})},deleteMessage:function(t){x.ajax({function:"delete-message",message_id:t},()=>{this.conversation.deleteMessage(t),e(c).find(`[data-id="${t}"]`).remove(),e(document).trigger("SBMessageDeleted",t)})},registration:function(){e(m).append(j.generate({},"registration","sb-init-form")),this.dashboard=!0,this.finalizeInit(),e(a).addClass("sb-init-form-active")},activateBar:function(t=!0){e(d).find(".sb-bar").sbActivate(t)},addUserAndLogin:function(e=!1){x.ajax({function:"add-user-and-login",login_app:T.login()},s=>{t("login",s[1]),i(new C(s[0])),!1!==e&&e(s)})},isInitDashboard:function(){return b["init-dashboard"]||0!=i()&&i().conversations.length>1}};window.SBChat=A;var j={rich_messsages:{buttons:'<div class="sb-buttons">[options]</div>',select:'<div class="sb-select"><p></p><ul>[options]</ul></div>',list:'<div class="sb-text-list">[values]</div>',table:"<table><tbody>[header][values]</tbody></table>",inputs:'<div class="sb-form">[values]</div>',rating:`<div class="sb-rating"><div class="sb-input sb-input-textarea"><textarea></textarea></div><div><div data-rating="positive" class="sb-submit"><i class="sb-icon-like"></i>${s("Good")}</div><div data-rating="negative" class="sb-submit"><i class="sb-icon-dislike"></i>${s("Bad")}</div></div></div>`},cache:{},generate:function(t,i,n=""){let o,r="",l=!0,c="id"in t?t.id:x.random();if(i in this.rich_messsages)o=this.rich_messsages[i];else if(i in this.cache)o=this.cache[i];else{if(!b["rich-messages"].includes(i))return!1;o='<div class="sb-rich-loading sb-loading"></div>',x.ajax({function:"get-rich-message",name:i},t=>{t=this.initInputs(t),"timetable"==i&&(t=this.timetable(t)),e(a).find(`.sb-rich-message[id="${c}"]`).html(`<div class="sb-content">${t}</div>`),this.cache[i]=t,A.scrollBottom(!!A.dashboard)}),l=!1}if(l){r="success"in t;let a=o.match(/\[.+?\]/g)||[];for(var d=0;d<a.length;d++){let n,r,l=a[d].slice(1,-1);if(l in t){switch(n="",r=t[l].split(","),l){case"options":for(h=0;h<r.length;h++)n+="select"==i?`<li data-value="${x.stringToSlug(r[h])}">${r[h]}</li>`:`<div class="sb-btn sb-submit">${r[h]}</div>`;break;case"values":let a="list"==i,c=a&&r.length&&r[0].indexOf(":")>0;c||(o=o.replace("sb-text-list","sb-text-list sb-text-list-single"));for(h=0;h<r.length;h++)if(c)n+=`<div><div>${r[h].split(":")[0]}</div><div>${r[h].split(":")[1]}</div></div>`;else if(a)n+=`<div>${e.trim(r[h])}</div>`;else if("table"==i){let e=r[h].split(":");n+="<tr>";for(var u=0;u<e.length;u++)n+=`<td>${e[u]}</td>`;n+="</tr>"}else"inputs"==i&&(n+=`<div id="${x.stringToSlug(r[h])}" data-type="text" class="sb-input sb-input-text"><span>${r[h]}</span><input autocomplete="false" type="text" required></div>`);"inputs"==i&&(n+='<div class="sb-btn sb-submit">'+s("button"in t?t.button:"Send now")+"</div>");break;case"header":n+="<tr>";for(var h=0;h<r.length;h++)n+=`<th>${r[h]}</th>`;n+="</tr>";break;default:n=t[l]}o=o.replace(a[d],n)}}}return`<div id="${c}" data-type="${i}" class="sb-rich-message sb-rich-${i} ${n}">`+("title"in t?`<div class="sb-top">${s(t.title)}</div>`:"")+("message"in t?`<div class="sb-text">${s(t.message)}</div>`:"")+`<div class="sb-content">${o}</div>`+(r?`<div data-success="${t.success.replace(/"/g,"")}" class="sb-info"></div>`:"")+"</div>"},submit:function(n,o,l){if(!r&&!e(l).sbLoading()&&!this.is_busy){let r="",d="",u={},h=e(n).find("[data-success]").length?e(n).find("[data-success]").attr("data-success"):"",g=e(n).closest(".sb-rich-message").attr("id"),f=e(n).closest("[data-id]").attr("data-id"),p="",m={"rich-messages":{}},v={profile_image:["",""],first_name:["",""],last_name:["",""],email:["",""],password:["",""],user_type:["",""]},_={},y=l,w="";if(x.null(f))f=-1;else{let e=A.conversation.getMessage(f);p=e.get("message"),"rich-messages"in(m=e.payload())||(m["rich-messages"]={})}switch(e(l).hasClass("sb-btn")&&e(l).hasClass("sb-select")||(y=e(l).closest(".sb-btn,.sb-select")),e(y).sbLoading(!0),e(n).find(".sb-info").html("").sbActivate(!1),o){case"email":"first_name"in(_=S.getAll(n))&&(v.user_type=["user",""]),e.extend(v,_),r="Please insert a valid email."+("first_name"in _?"":" All fields are required."),h=`${s(""==h?"Your email is":h)} *${v.email[0]}*`,m["rich-messages"][g]={type:o,result:_},m.event="update-user",u={function:"update-user-and-message",settings:v,payload:m},w="email-complete";break;case"select":case"buttons":_=e(l).html(),h=`${s(""==h?"Your selected the option":h)} *${_}*`,m["rich-messages"][g]={type:o,result:_},u={function:"update-message",payload:m},w=_;break;case"inputs":_=S.getAll(n),h=`${s(""==h?"You inserted the values below.":h)} [list values="`,r="All fields are required.";for(var c in _)h+=`${_[c][1].replace(/:|,/g,"")}:${_[c][0].replace(/:|,/g,"")},`;h=h.slice(0,-1)+'"]',m["rich-messages"][g]={type:o,result:_},u={function:"update-message",payload:m},w="inputs-complete";break;case"registration":let t=S.getAll(n.find(".sb-form-extra")),a=e.extend({},v,t);e.extend(v,S.getAll(n.find(".sb-form-main"))),h=`${s(""==h?"Your account details are the following.":h)} [list values="`;for(var c in v){let e=v[c][0].replace(/:|,/g,"");""!=e&&("profile_image"==c&&(e=e.substr(e.lastIndexOf("/")+1)),"password"!=c&&"password-check"!=c||(e="********",a[c]="********"),h+=`${v[c][1].replace(/:|,/g,"")}:${e},`)}for(var c in t)""!=t[c][0]&&(h+=`${t[c][1].replace(/:|,/g,"")}:${t[c][0].replace(/:|,/g,"")},`);v.user_type=["user",""],h=h.slice(0,-1)+'"]',m["rich-messages"][g]={type:o,result:a},m.event="update-user",u={function:0!=i()?"update-user-and-message":"add-user-and-login",settings:v,settings_extra:t,payload:m},r=n.find("#password").length?"Please insert your name, last name, a valid email and a password of min 8 chars.":"Please insert your name, last name and a valid email.",w="registration-complete";break;case"rating":let d=e(l).attr("data-rating");h=`${s("Your rating is")} *${s(d)}*. ${s(""==h?"Thank you for your feedback!":h)}`,_={conversation_id:A.conversation.id,agent_id:A.agent_id,user_id:i().id,message:n.find("textarea").val(),rating:"positive"==d?1:-1},m["rich-messages"][g]={type:o,result:_},u={function:"set-rating",payload:m,settings:_},w=d}if(d=p.substr(p.indexOf("["+o)),d=d.substr(0,d.indexOf("]")+1),""!=r&&S.errors(n))return S.showErrorMessage(n,r),e(y).sbLoading(!1),(A.dashboard||!1!==A.conversation&&A.conversation.getLastMessage().id==f)&&A.scrollBottom(),!1;-1!=f&&e.extend(u,{message_id:f,message:""!=p?p.replace(d,h):h,payload:m}),x.ajax(u,s=>{if(0!=s&&"duplicate-email"!=s){switch(o){case"email":for(var r in v)i().set(r,v[r][0]);break;case"registration":if(0==i())t("login",s[1]),i(new C(s[0])),e(a).removeClass("sb-init-form-active"),e(n).remove(),A.initChat(),A.sendMessage(b["bot-id"],h),A.isInitDashboard()||A.hideDashboard();else for(var r in v)i().set(r,v[r][0])}-1==f?e(l).closest(".sb-rich-message").html(h):A.setConversationStatus(2),"email"!=o&&"registration"!=o&&"login"!=o&&A.sendBotMessage(`${g}|${o}|${w}`),b["slack-active"]&&A.slackMessage(i().id,i().get("full_name"),i().get("profile_image"),h)}else{let t="";t="duplicate-email"==s?"This email is already in use. Please use another email.":"Error. Please check your information and try again.",S.showErrorMessage(n,t),e(y).sbLoading(!1)}})}},shortcode:function(t){if(t.indexOf(" ")<0)return[t.slice(1,-1),{}];let s={},i=t.substr(1,t.indexOf(" ")-1),a=(t=t.slice(1,-1).substr(i.length+1)).split('" ');for(var n=0;n<a.length;n++)if(a[n].indexOf("=")>-1){let t=a[n].split("=");s[e.trim(t[0])]=t[1].replace(/"/g,"")}return[i,s]},initInputs:function(t){return t=e.parseHTML("<div>"+t+"</div>"),e(t).find(".sb-input input").each(function(){""!=e(this).val()&&e(this).siblings().addClass("sb-active sb-filled")}),e(t).html()},timetable:function(t){let i=e.parseHTML(`<div>${t}</div>`);return e(i).find("[data-time]").each(function(){let a=e(this).attr("data-time").split("|");t="";for(var n=0;n<a.length;n++){if("closed"==a[n]){t+=s("Closed");break}if(""!=a[n]){let e=parseInt(a[n].split(":")[0]),i=a[n].split(":")[1];e>24&&(e-=24),e<0&&(e=24-e);let o=new Date(`01-01-2000 ${e}:${i} UTC`);t+=o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})+(0==n||2==n?`<span>${s("to")}</span>`:1==n&&""!=a[n+1]?"<br />":"")}}e(i).find(" > div > span").html(`<i class="sb-icon-clock"></i> ${s("Time zone")} ${Intl.DateTimeFormat().resolvedOptions().timeZone}`),e(this).html(t)}),e(i).html()}},S={getAll:function(t){let s={};return e(t).find(".sb-input").each((t,i)=>{s[e(i).attr("id")]=this.get(i)}),s},get:function(t){let s=e(t).data("type"),i=e(t).find(" > span").html();switch(s){case"image":let a=e(t).find(".image").attr("data-url");return[x.null(a)?"":a,i];case"select":return[e(t).find("select").val(),i];default:return[e(t).find("input").val(),i]}},set:function(t,s){if(e(t).length){switch(e(t).data("type")){case"image":""==s?e(t).find(".image").removeAttr("data-url").removeAttr("style"):e(t).find(".image").attr("data-url",s).css("background-image",`url(${s})`);break;case"select":e(t).find("select").val(s);break;default:e(t).find("input").val(s)}return!0}return!1},clear:function(t){e(t).find(".sb-input").each((e,t)=>{this.set(t,"")}),this.set(e(t).find("#user_type"),"user")},errors:function(t){let s=!1,i=e(t).find("[required]");return e(i).each(function(t){let a=e(this).attr("type"),n=e(this).val();if(""==n)return s=!0,!1;if("password"==a){if("password"==a&&(n.length<8||i.length>t+1&&"password"==e(i[t+1]).attr("type")&&e(i[t+1]).val()!=n))return s=!0,!1}else if("email"==a&&(n.indexOf("@")<0||n.indexOf(".")<0))return s=!0,!1}),s},showErrorMessage:function(t,i){e(t).find(".sb-info").html(s(i)).sbActivate(),clearTimeout(v),v=setTimeout(function(){e(t).find(".sb-info").sbActivate(!1)},7e3)},showSuccessMessage:function(t,s){e(t).find(".sb-info").remove(),e(t).addClass("sb-success").find(".sb-content").html(`<div class="sb-text">${s}</div>`)}};window.SBForm=S;var T={isWP:function(){return b.wp},isLoggedWP:function(){return b.wp&&!1!==SB_WP_ACTIVE_USER},login:function(){return!!this.isWP()&&("wp"==b["wp-users-system"]&&SB_WP_ACTIVE_USER)}};e(document).ready(function(){a=e("body").find(".sb-conversation, .sb-chat"),r=e(a).hasClass("sb-conversation"),a.length&&(c=e(a).find(".sb-list"),d=e(a).find(".sb-editor"),u=e(d).find("textarea"),m=e(a).find(r?".sb-list":".sb-scroll-area"),h=e(m).find(".sb-header"),f=e(d).find(".sb-replies"),p=e(d).find(".sb-emoji"),A.enabledAutoExpand(),A.audio=e(a).find("#sb-audio")[0],x.ajax({function:"get-front-settings"},e=>{b=e,r||b["chat-manual-init"]||b["disable-office-hours"]&&!b["office-hours"]||!(!b["chat-login-init"]||!T.isWP()&&0!=t("login")||T.isWP()&&T.isLoggedWP())||T.isWP()&&0!=b["wp-show-ids"].length&&!b["wp-show-ids"].includes(SB_WP_PAGE_ID)||A.initChat()}),r||e(d).on("keydown","textarea",function(t){if(13==t.which)return e(d).find(".sb-submit").click(),t.preventDefault,!1})),document.addEventListener("visibilitychange",function(){"hidden"==document.visibilityState?(A.stopRealTime(),A.tab_active=!1):(A.startRealTime(),A.tab_active=!0,document.title=_)},!1),0==a.length&&(a=e("body").find(".sb-admin"),r=!0),n=r?e(a).closest(".sb-admin"):a,e(m).on("scroll",function(e){A.scrollHeader()}),e(c).on("click",".sb-menu-btn",function(){let t=e(this).parent().find(".sb-menu"),s=e(t).sbActive();x.deactivateAll(),s||(e(t).sbActivate(),x.deselectAll())}),y&&(e(d).on("click",".sb-textarea",function(){e(a).addClass("sb-header-hidden"),e(this).find("textarea").focus()}),e(d).on("focusout",".sb-textarea",function(){setTimeout(()=>{e(a).removeClass("sb-header-hidden")},300)}),e(d).on("click",".sb-submit",function(){e(u).blur()})),e(c).on("click",".sb-menu li",function(){e(this).parent().sbActivate(!1)}),e(c).on("click",'.sb-menu [data-value="delete"]',function(){let t=e(this).closest("[data-id]"),s=e(t).attr("data-id");A.user_online?x.ajax({function:"update-message",user_id:A.conversation.getMessage(s).get("user_id"),message_id:s,message:"",attachments:[],payload:{event:"delete-message"}},()=>{A.conversation.deleteMessage(s),e(c).find(`[data-id="${s}"]`).remove()}):A.deleteMessage(s)}),e(d).on("click",".sb-submit",function(){if(!A.is_busy){if(0==i()&&!r)return void A.addUserAndLogin(()=>{A.newConversation(2)});A.sendMessage(),A.activateBar(!1)}}),e(a).on("click",".sb-chat-btn,.sb-responsive-close-btn",function(){A.openButton()}),e(a).on("click",".sb-dashboard-btn",function(){A.showDashboard()}),e(a).on("click",".sb-user-conversations li",function(){A.openConversation(e(this).attr("data-conversation-id"))}),e(a).on("click",".sb-btn-new-conversation",function(){A.clear(),A.hideDashboard()}),e(d).on("click",".sb-btn-attachment",function(){A.is_busy||e(d).find(".sb-upload-files").val("").click()}),e(d).on("click",".sb-attachments > div > i",function(t){return e(this).parent().remove(),""==e(u).val()&&0==e(d).find(".sb-attachments > div").length&&A.activateBar(!1),t.preventDefault(),!1}),e(d).find(".sb-upload-files").change(function(t){A.busy(!0),e(this).sbUploadFiles(function(t){if("success"==(t=JSON.parse(t))[0])if("extension_error"==t[1])x.dialog("The file you are trying to upload has an extension that is not allowed.","info");else if(e(o).hasClass("sb-input-image"))e(o).find(".image").attr("data-url","").css("background-image",""),setTimeout(()=>{e(o).find(".image").attr("data-url",t[1]).css("background-image",`url(${t[1]}?v=${x.random()})`).append('<i class="sb-icon-close"></i>'),o=!1},500);else{let s=t[1].substr(t[1].lastIndexOf("/")+1);e(d).find(".sb-attachments").append(`<div data-name="${s}" data-url="${t[1]}">${s}<i class="sb-icon-close"></i></div>`),A.activateBar()}else x.error(t[1],"sb-upload-files.change");A.busy(!1)})}),e(a).on("click",".sb-btn-all-articles",function(){A.showArticles()}),e(a).on("click",".sb-articles > div",function(){A.showArticles(e(this).attr("data-id"))}),e(a).on("click",".sb-dashboard-articles .sb-input-btn .sb-submit",function(){A.searchArticles(e(this).parent().find("input").val(),this)}),e(a).on("click",".sb-image",function(){x.lightbox(e(this).html())}),e(a).on("click",".sb-lightbox-overlay,.sb-lightbox-overlay > i",function(){return e(a).find(".sb-lightbox").sbActivate(!1),!1}),e(d).on("click",".sb-btn-emoji",function(){A.showEmoji(this)}),e(p).on("click",".sb-emoji-list li",function(t){A.insertEmoji(e(this).html()),y&&clearTimeout(v)}),e(p).find(".sb-emoji-list").on("touchend",function(e){v=setTimeout(()=>{A.mouseWheelEmoji(e)},50)}),e(p).find(".sb-emoji-list").on("mousewheel DOMMouseScroll",function(e){A.mouseWheelEmoji(e)}),e(p).find(".sb-emoji-list").on("touchstart",function(e){A.emoji_options.touch=e.originalEvent.touches[0].clientY}),e(p).on("click",".sb-emoji-bar > div",function(){A.clickEmojiBar(this)}),e(p).on("click",".sb-select li",function(){A.categoryEmoji(e(this).data("value"))}),e(p).find(".sb-search-btn input").on("change keyup paste",function(){A.searchEmoji(e(this).val())}),e(d).on("click",".sb-btn-saved-replies",function(){A.showBox(this)}),e(f).on("click",".sb-replies-list li",function(){A.insertContent(e(this).find("div:last-child").html())}),e(f).find(".sb-search-btn input").on("keyup",function(){A.searchReplies(e(this).val())}),e(u).on("keyup",function(){A.textareaChange(this)}),e(a).on("click",".sb-privacy .sb-approve",function(){t("privacy-approved",!0),e(this).closest(".sb-privacy").remove(),e(a).removeClass("sb-init-form-active"),e(h).find(" > div").css({opacity:1,top:0}),A.initialized=!1,A.initChat()}),e(a).on("click",".sb-privacy .sb-decline",function(){let t=e(this).closest(".sb-privacy");e(t).find(".sb-text").html(e(t).attr("data-decline")),e(t).find(".sb-decline").remove(),A.scrollBottom(!0)}),e(a).on("click",".sb-popup-message .sb-icon-close",function(){A.popup("close")}),e(a).on("click",".sb-rich-message .sb-submit,.sb-rich-message .sb-select ul li",function(){let t=e(this).closest(".sb-rich-message");j.submit(t,e(t).attr("data-type"),this)}),e(a).on("click",".sb-rich-message .sb-input > span",function(){e(this).sbActivate(),e(this).siblings().focus()}),e(a).on("focus",".sb-rich-message .sb-input input",function(){e(this).siblings().sbActivate()}),e(a).on("click",".sb-rich-message .sb-input input",function(){e(this).siblings().removeClass("sb-filled")}),e(a).on("focusout",".sb-rich-message .sb-input input",function(){""==e(this).val()?e(this).siblings().sbActivate(!1):e(this).siblings().addClass("sb-filled sb-active")}),e(a).on("click",".sb-rich-registration .sb-login-area",function(){e(this).closest(".sb-rich-registration").replaceWith(j.generate({},"login","sb-init-form")),A.scrollBottom(!0)}),e(a).on("click",".sb-rich-login .sb-registration-area",function(){e(this).closest(".sb-rich-login").replaceWith(j.generate({},"registration","sb-init-form")),A.scrollBottom(!0)}),e(a).on("click",".sb-rich-login .sb-submit-login",function(){x.login(this)}),e(n).on("click",".sb-search-btn > i",function(){e(this).parent().toggleClass("sb-active"),e(this).parent().find("input").focus(),e(n).find(".sb-select ul").sbActivate(!1)}),e(n).on("click",".sb-select",function(){e(this).find("ul").toggleClass("sb-active")}),e(n).on("click",".sb-select li",function(){let t=e(this).closest(".sb-select"),s=e(this).data("value");var i=""===s?e(t).find(".sb-active"):e(t).find(`[data-value="${s}"]`);e(t).find("li").sbActivate(!1),e(t).find("p").html(e(i).html()),e(i).sbActivate()}),e(n).on("click",".sb-input-image .image",function(){o=e(this).parent(),e(d).find(".sb-upload-files").click()}),e(n).on("click",".sb-input-image .image > .sb-icon-close",function(t){return e(this).parent().removeAttr("data-url").css("background-image",""),t.preventDefault(),!1})})}(jQuery);