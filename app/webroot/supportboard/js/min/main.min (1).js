"use strict";!function(t){function e(t,e=!1){let s=localStorage.getItem("support-board");if(s=null===s?{}:JSON.parse(s),!1===e)return t in s&&s[t];""==e?delete s[t]:s[t]=e,localStorage.setItem("support-board",JSON.stringify(s))}function s(t){if(v.null(p))return t;let e=p.translations;return 0!=e&&t in e?""==e[t]?t:e[t]:t}function i(t){if(void 0===t)return window.sb_current_user;window.sb_current_user=t}var a,n,o,l,r,c,d,u,h,g,f,p,m=!1,b=document.title;t(document).ready(function(){a=t("body").find(".sb-conversation, .sb-chat"),l=t(a).hasClass("sb-conversation"),a.length&&(c=t(a).find(".sb-list"),d=t(a).find(".sb-editor"),u=t(a).find(".sb-chat-scroll .sb-header"),g=t(d).find(".sb-replies"),f=t(d).find(".sb-emoji"),x.enabledAutoExpand(),x.audio=t(a).find("#sb-audio")[0],v.ajax({function:"get-front-settings"},t=>{p=t,l||p["chat-manual-init"]||p["disable-office-hours"]&&!p["office-hours"]||x.initChat()}),l||t(d).on("keydown","textarea",function(e){if(13==e.which)return t(d).find(".sb-submit").click(),e.preventDefault,!1})),document.addEventListener("visibilitychange",function(){"hidden"==document.visibilityState?(x.stopRealTime(),x.tab_active=!1):(x.startRealTime(),x.tab_active=!0,document.title=b)},!1),0==a.length&&(a=t("body").find(".sb-admin"),l=!0),n=l?t(a).closest(".sb-admin"):a,t(a).bind("mousewheel DOMMouseScroll",function(t){x.scrollHeader(t.originalEvent.wheelDelta)}),t(a).find(".sb-chat-scroll").slimScroll().bind("slimscroll",function(t,e){x.scroll_settings.position="scrolling"!=e?e:""}),t(c).on("click",".sb-menu-btn",function(){var e=t(this).parent().find(".sb-menu"),s=t(e).hasClass("sb-active");v.deactivateAll(),s||(t(this).parent().find(".sb-menu").sbActivate(),v.deselectAll())}),t(c).on("click",".sb-menu li",function(){t(this).parent().sbActivate(!1)}),t(c).on("click",'.sb-menu [data-value="delete"]',function(){let e=t(this).closest("[data-id]"),s=t(e).attr("data-id");x.user_online?v.ajax({function:"update-message",user_id:x.conversation.getMessage(s).get("user_id"),message_id:s,message:"",attachments:"",payload:{event:"delete-message"}},()=>{x.conversation.deleteMessage(s),t(c).find(`[data-id="${s}"]`).remove()}):x.deleteMessage(s)}),t(d).on("click",".sb-submit",function(){if(!x.is_busy){if(0==i()&&!l)return void v.ajax({function:"add-user-and-login"},t=>{e("login",t[1]),i(new _(t[0])),x.newConversation(2)});x.sendMessage()}}),t(a).on("click",".sb-chat-btn",function(){x.openButton()}),t(a).on("click",".sb-dashboard-btn",function(){x.showDashboard()}),t(a).on("click",".sb-user-conversations li",function(){x.openConversation(t(this).attr("data-conversation-id"))}),t(a).on("click",".sb-btn-new-conversation",function(){x.clear(),x.hideDashboard(),x.setScroll()}),t(d).on("click",".sb-btn-attachment",function(){x.is_busy||t(d).find(".sb-upload-files").val("").click()}),t(d).on("click",".sb-attachments > div > i",function(e){return t(this).parent().remove(),e.preventDefault(),!1}),t(d).find(".sb-upload-files").change(function(e){x.busy(!0),t(this).sbUploadFiles(function(e){if("success"==(e=JSON.parse(e))[0])if("extension_error"==e[1])v.dialog("The file you are trying to upload has an extension that is not allowed.","info");else if(t(o).hasClass("sb-input-image")){let s=`${SB_URL}/uploads/${e[1]}`;t(o).find(".image").attr("data-url",s).css("background-image",`url(${s})`).append('<i class="sb-icon-close"></i>'),o=!1}else{let s=e[1].substr(e[1].lastIndexOf("/")+1);t(d).find(".sb-attachments").append(`<div data-name="${s}" data-url="${SB_URL}/uploads/${e[1]}">${s}<i class="sb-icon-close"></i></div>`)}else v.error(e[1],"sb-upload-files.change");x.busy(!1)})}),t(a).on("click",".sb-btn-all-articles",function(){x.showArticles()}),t(a).on("click",".sb-articles > div",function(){x.showArticles(t(this).attr("data-id"))}),t(a).on("click",".sb-dashboard-articles .sb-input-btn .sb-submit",function(){x.searchArticles(t(this).parent().find("input").val(),this)}),t(a).on("click",".sb-image",function(){v.lightbox(t(this).html())}),t(a).on("click",".sb-lightbox-overlay > i",function(){t(a).find(".sb-lightbox").sbActivate(!1)}),t(d).on("click",".sb-btn-emoji",function(){x.showEmoji(this)}),t(f).on("click",".sb-emoji-list li",function(){x.insertEmoji(t(this).html())}),t(f).find(".sb-emoji-list").bind("mousewheel DOMMouseScroll",function(t){x.mouseWheelEmoji(t)}),t(f).on("click",".sb-emoji-bar > div",function(){x.clickEmojiBar(this)}),t(f).on("click",".sb-select li",function(){x.categoryEmoji(t(this).data("value"))}),t(f).find(".sb-search-btn input").on("change keyup paste",function(){x.searchEmoji(t(this).val())}),t(d).on("click",".sb-btn-saved-replies",function(){x.showBox(this)}),t(g).on("click",".sb-replies-list li",function(){x.insertContent(t(this).find("div:last-child").html())}),t(g).find(".sb-search-btn input").on("keyup",function(){x.searchReplies(t(this).val())}),t(d).find("textarea").on("keyup",function(){x.textareaChange(this)}),t(a).on("click",".sb-privacy .sb-approve",function(){e("privacy-approved",!0),t(this).closest(".sb-privacy").remove(),t(a).removeClass("sb-init-form-active"),t(u).find(" > div").css({opacity:1,top:0}),x.dashboard=!1,x.initChat()}),t(a).on("click",".sb-privacy .sb-decline",function(){let e=t(this).closest(".sb-privacy");t(e).find(".sb-text").html(t(e).attr("data-decline")),t(e).find(".sb-decline").remove(),x.scrollBottom(!0)}),t(a).on("click",".sb-popup-message .sb-icon-close",function(){x.popup("close")}),t(a).on("click",".sb-rich-message .sb-submit,.sb-rich-message .sb-select ul li",function(){let e=t(this).closest(".sb-rich-message");C.submit(e,t(e).attr("data-type"),this)}),t(a).on("click",".sb-rich-message .sb-input > span",function(){t(this).sbActivate(),t(this).siblings().focus()}),t(a).on("focus",".sb-rich-message .sb-input input",function(){t(this).siblings().sbActivate()}),t(a).on("click",".sb-rich-message .sb-input input",function(){t(this).siblings().removeClass("sb-filled")}),t(a).on("focusout",".sb-rich-message .sb-input input",function(){""==t(this).val()?t(this).siblings().sbActivate(!1):t(this).siblings().addClass("sb-filled sb-active")}),t(a).on("click",".sb-rich-registration .sb-login-area",function(){t(this).closest(".sb-rich-registration").replaceWith(C.generate({},"login","sb-init-form")),x.scrollBottom(!0)}),t(a).on("click",".sb-rich-login .sb-registration-area",function(){t(this).closest(".sb-rich-login").replaceWith(C.generate({},"registration","sb-init-form")),x.scrollBottom(!0)}),t(a).on("click",".sb-rich-login .sb-submit-login",function(){v.login(this)}),t(n).on("click",".sb-search-btn > i",function(){t(this).parent().toggleClass("sb-active"),t(this).parent().find("input").focus(),t(n).find(".sb-select ul").sbActivate(!1)}),t(n).on("click",".sb-select",function(){t(this).find("ul").toggleClass("sb-active")}),t(n).on("click",".sb-select li",function(){let e=t(this).closest(".sb-select"),s=t(this).data("value");var i=""===s?t(e).find(".sb-active"):t(e).find(`[data-value="${s}"]`);t(e).find("li").sbActivate(!1),t(e).find("p").html(t(i).html()),t(i).sbActivate()}),t(n).on("click",".sb-input-image .image",function(){o=t(this).parent(),t(d).find(".sb-upload-files").click()}),t(n).on("click",".sb-input-image .image > .sb-icon-close",function(e){return t(this).parent().removeAttr("data-url").css("background-image",""),e.preventDefault(),!1})});var v={ajax:function(e,s=!1){"user_id"in e||0==i()||(e.user_id=i().id),"undefined"!=typeof SB_LANG&&(e.language=SB_LANG),t.ajax({method:"POST",url:SB_AJAX_URL,data:e}).done(t=>{let i;try{i=JSON.parse(t)}catch(s){console.log(t),v.error("Json parse error",`SBF.ajax.${e.function}`)}"success"==i[0]?0!=s&&s(i[1]):v.error(i[1],`SBF.ajax.${e.function}`)})},cors:function(t="GET",e,s){var i=new XMLHttpRequest;if("withCredentials"in i)i.open(t,e,!0);else{if("undefined"==typeof XDomainRequest)return!1;(i=new XDomainRequest).open(t,e)}i.onload=function(){s(i.responseText)},i.onerror=function(){return!1},i.send()},null:function(t){return void 0===t||null===t||"null"===t||!1===t||!(t.length>0||"number"==typeof t||void 0===t.length)||"undefined"===t},deactivateAll:function(){t(n).find(".sb-popup, .sb-tooltip, .sb-list .sb-menu, .sb-select ul").sbActivate(!1)},deselectAll:function(){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},getURL:function(t){return decodeURIComponent((new RegExp("[?|&]"+t+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20")||"")},restoreJson:function(t){return v.null(t)?"":t.replace(/\\n/g,"\n").replace(/\\r/g,"\r").replace(/\\t/g,"\t").replace(/\\f/g,"\f").replace(/\\'/g,"'").replace(/\\"/g,'"').replace(/\\\\/g,"\\")},stringToSlug:function(t){t=(t=t.trim()).toLowerCase();for(var e="������������������������/_,:;",s=0,i=e.length;s<i;s++)t=t.replace(new RegExp(e.charAt(s),"g"),"aaaaaaeeeeiiiioooouuuunc------".charAt(s));return t.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-+/,"").replace(/-+$/,"").replace(/ /g," ")},slugToString:function(t){return(t=t.replace(/_/g," ")).charAt(0).toUpperCase()+t.slice(1)},random:function(){let t="";for(var e=5;e>0;--e)t+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return t},isAgent:function(t){return"agent"==t||"admin"==t||"bot"==t},beautifyTime:function(t){if("0000-00-00 00:00:00"==t)return"";let e=new Date(t+" UTC"),i=Math.round((new Date-e)/864e5),a=[s("Sunday"),s("Monday"),s("Tuesday"),s("Wednesday"),s("Thursday"),s("Friday"),s("Saturday")];return i<1?e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):i<8?a[e.getDay()]:e.toLocaleDateString()},updateUsersActivity:function(t,e,s){v.ajax({function:"update-users-last-activity",user_id:t,return_user_id:e,check_slack:!l&&p["slack-active"]},t=>{s("online"===t?"online":"offline")})},search:function(t,e){(t=t.toLowerCase())!=r&&(clearTimeout(m),m=setTimeout(function(){r=t,e()},200))},searchClear:function(e,s){""!=t(e).next().val()&&(s(),t(e).next().val(""))},error:function(e,s){throw e instanceof Error&&(e=e.message),"."==e[e.length-1]&&(e=e.slice(0,-1)),e.indexOf("Support Board Error")>-1&&(e=e.replace("Support Board Error ","").replace("]:","]")),l&&v.dialog(`[Error] [${s}] ${e}. Check the console for more details.`,"info"),t(n).find(".sb-loading").sbLoading(!1),new Error(`Support Board Error [${s}]: ${e}.`)},login:function(n){if(!t(n).sbLoading()){let o=t(n).closest(".sb-rich-login"),r=t(o).find("#email input").val(),c=t(o).find("#password input").val();""==r||""==c?t(o).find(".sb-info").html(s("Please insert email and password.")).sbActivate():(v.ajax({function:"login",email:r,password:c},r=>{0!=r&&Array.isArray(r)?!l&&this.isAgent(r[0].user_type)?t(o).find(".sb-info").html(s("You can not sign in as agent.")).sbActivate():(e("login",r[1]),l?location.reload():(i(new _(r[0])),t(a).removeClass("sb-init-form-active"),t(o).remove(),x.initChat())):t(o).find(".sb-info").html(s("Invalid email or password.")).sbActivate(),t(n).sbLoading(!1)}),t(o).find(".sb-info").html("").sbActivate(!1),t(n).sbLoading(!0))}},logout:function(){v.ajax({function:"logout"},()=>{e("login",""),location.reload()})},dialog:function(t,e,s){l&&sbDialogAdmin(t,e,s)},lightbox:function(e){t(a).find(".sb-lightbox").sbActivate().find(" > div").html(e)}};window.SBF=v,window.sb_current_user=!1,t.fn.sbActivate=function(e=!0){return e?t(this).addClass("sb-active"):t(this).removeClass("sb-active"),this},t.fn.sbLoading=function(e="check"){return"check"==e?t(this).hasClass("sb-loading"):(1==e&&t(this).addClass("sb-loading"),0==e&&t(this).removeClass("sb-loading"),this)},t.fn.sbTogglePopup=function(e){var s=!0;return t(this).hasClass("sb-active")?(t(this).sbActivate(!1),t(n).removeClass("sb-popup-active"),s=!1):(t(n).addClass("sb-popup-active"),t(n).find(".sb-popup").sbActivate(!1),t(this).css("left",t(e).offset().left+15).sbActivate(),v.deselectAll()),s},t.fn.sbUploadFiles=function(e){for(var s=t(this).prop("files"),i=0;i<s.length;i++){var a=s[i],n=new FormData;n.append("file",a),jQuery.ajax({url:SB_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:n,type:"post",success:function(t){e(t)}})}t(this).value=""};class _{constructor(t={},e={}){this.details=t,this.extra=e,this.conversations=[]}get id(){return""==this.get("id")?this.get("user_id"):this.get("id")}get(t){return"full_name"==t?"first_name"in this.details?this.details.first_name+" "+this.details.last_name:"":t in this.details&&!v.null(this.details[t])?this.details[t]:""}getExtra(t){return t in this.extra&&!v.null(this.extra[t])?this.extra[t]:""}set(t,e){this.details[t]=e}setExtra(t,e){this.extra[t]=e}update(t){v.ajax({function:"get-user",user_id:this.id,extra:!0},e=>{for(var s=0;s<e.details.length;s++)this.setExtra(e.details[s].slug,e.details[s]);delete e.details,this.details=e,t()})}getConversations(t,e){v.ajax({function:"get-user-conversations",user_id:this.id,exclude_id:e},e=>{let s=[];for(var i=0;i<e.length;i++){let t=new w([new y(e[i])]);t.set("id",e[i].conversation_id),t.set("conversation_status_code",e[i].conversation_status_code),s.push(t)}this.conversations=s,t(s)})}getConversationsCode(t=!1){let e="";0==t&&(t=this.conversations);for(var i=0;i<t.length;i++)t[i]instanceof w?e+=`<li data-conversation-status="${t[i].get("conversation_status_code")}" data-conversation-id="${t[i].id}">${t[i].getCode()}</li>`:v.error("Conversation not of type SBConversation","SBUser.getConversationsCode");return""==e&&(e=`<p class="sb-no-results">${s("No conversations found.")}</p>`),e}getFullConversation(t,e){v.ajax({function:"get-conversation",conversation_id:t},t=>{let s=[];for(var i=0;i<t.messages.length;i++)s.push(new y(t.messages[i]));e(new w(s,t.details))})}addConversation(t){if(t instanceof w){let s=t.id,i=!0;for(var e=0;e<this.conversations.length;e++)if(this.conversations[e].id==s){this.conversations[e]=t,i=!1;break}i&&this.conversations.unshift(t)}else v.error("Conversation not of type SBConversation","SBUser.addConversation")}isConversationsEmpty(){return 0==this.conversations.length}isExtraEmpty(){return 0===Object.keys(this.extra).length&&this.extra.constructor===Object}delete(e){v.ajax({function:"delete-user",user_id:this.id},s=>(t(document).trigger("SBUserDeleted",this.id),e(),!0))}}window.SBUser=_;class y{constructor(t){this.details=t,"first_name"in this.details&&(this.details.full_name=this.details.first_name+" "+this.details.last_name),this.set("payload",""!=this.get("payload")?JSON.parse(this.get("payload")):{})}get id(){return this.get("id")}get(t){return t in this.details&&!v.null(this.details[t])?this.details[t]:""}set(t,e){this.details[t]=e}payload(t=!1){if(!1!==t){let e=this.get("payload");e[key]=t,this.set("payload",e)}return this.get("payload")}getCode(){let t=v.isAgent(this.details.user_type),e=l&&t?`<i class="sb-menu-btn sb-icon-menu"></i><ul class="sb-menu"><li data-value="save">${s("Save as reply")}</li>${p["dialogflow-active"]?`<li data-value="bot">${s("Send to Dialogflow")}</li>`:""}<li data-value="delete">${s("Delete")}</li></ul>`:"",i=this.render(this.details.message),a=v.null(this.details.attachments)?[]:JSON.parse(this.details.attachments),n="",o="",r=l||t&&!p["hide-agents-thumb"]||!t&&p["display-users-thumb"]?`<div class="sb-thumb"><img src="${this.details.profile_image}"><div>${this.details.full_name}</div></div>`:"",c=(t?"":"sb-right")+(""==r?"":" sb-thumb-active");if(""==i&&0==a.length)return"";if(t){let t=i.match(/\[.+?\]/g)||[];for(d=0;d<t.length;d++){let e=C.shortcode(t[d]),s=C.generate(e[1],e[0]);0!=s&&("["!=i.charAt(0)&&(s=s.replace("sb-rich-message","sb-rich-message sb-margin-top")),"]"!=i.charAt(i.length-1)&&(s=s.replace("sb-rich-message","sb-rich-message sb-margin-bottom")),i=i.replace(t[d],s))}}if(a.length){n='<div class="sb-message-attachments">';for(var d=0;d<a.length;d++)/.jpg|.png|.gif/.test(a[d][1])?o+=`<div class="sb-image"><img src="${a[d][1]}" /></div>`:n+=`<a rel="noopener" target="_blank" href="${a[d][1]}">${a[d][0]}</a>`;n+="</div>"}return`<div data-id="${this.details.id}" class="${c}">${r}<div class="sb-cnt"><div class="sb-message${""!=o&&""==i?" sb-message-media":""}">${i}${o}</div>${n}<div class="sb-time">${v.beautifyTime(this.details.creation_time)}</div></div>${e}</div>`}render(e=!1){!1===e&&(e=""+this.details.message);let s=e.match(/```(.*)```/s)||[];for(i=0;i<s.length;i++)e=e.replace(s[i],"[code-"+i+"]");(e=(e=(e=(e=(e=(e=e.replace(/(?:\r\n|\r|\n)/g,"<br>")).replace(/\*([^\**]+)\*/g,"<b>$1</b>")).replace(/\_([^\__]+)\_/g,"<i>$1</i>")).replace(/\_([^\__]+)\_/g,"<i>$1</i>")).replace(/\~([^\~~]+)\~/g,"<del>$1</del>")).replace(/\`([^\``]+)\`/g,"<code>$1</code>")).length<3&&e.match(/(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|\ud83c[\ude32-\ude3a]|\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/)&&(e=`<span class="emoji-large">${e}</span>`),e.indexOf("http")>-1&&(e=e.autoLink({target:"_blank"}));for(var i=0;i<s.length;i++)e=e.replace("[code-"+i+"]","<pre>"+t.trim(t.trim(s[i]).substr(3,s[i].length-6).replace(/(?:\r\n|\r|\n)/g,"<br>")))+"</pre>";return e}}window.SBMessage=y;class w{constructor(t,e){this.details=v.null(e)?{}:e,Array.isArray(t)?(this.messages=[],t.length&&(t[0]instanceof y?this.messages=t:v.error("Messages not of type SBMessages","SBConversation.constructor"))):v.error("Message array not of type Array","SBConversation.constructor")}get id(){return this.get("id")}get(t){if(t in this.details&&!v.null(this.details[t]))return this.details[t];if("title"==t){if(!v.null(this.details.first_name))return this.details.first_name+" "+this.details.last_name;if(this.messages.length)return this.messages[0].get("full_name")}return""}set(t,e){this.details[t]=e}getMessage(t){for(var e=0;e<this.messages.length;e++)if(this.messages[e].id==t)return this.messages[e];return!1}updateMessage(t,e){for(var s=0;s<this.messages.length;s++)if(this.messages[s].id==t)return this.messages[s]=e,!0;return!1}deleteMessage(t){for(var e=0;e<this.messages.length;e++)if(this.messages[e].id==t)return this.messages.splice(e,1),!0;return!1}getLastMessage(){let t=this.messages.length;return t>0&&this.messages[t-1]}addMessages(t){if(Array.isArray(t))for(var e=0;e<t.length;e++)t[e]instanceof y&&this.messages.push(t[e]);else t instanceof y?this.messages.push(t):v.error("Messages not of type SBMessages","SBConversation.addMessages()")}getCode(){if(this.messages.length){let t=this.messages[0].get("message");return t.length>114&&(t=t.substr(0,114)+" ..."),`<div class="sb-conversation-item" data-user-id="${this.messages[0].get("user_id")}"><img src="${this.messages[0].get("profile_image")}"><div><span class="sb-name">${this.messages[0].get("full_name")}</span><span class="sb-time">${v.beautifyTime(this.messages[0].get("creation_time"))}</span></div><div class="sb-message">${t}</div></div>`}return""}}window.SBConversation=w;var x={replies_list:[],rich_messages_list:["buttons","select","inputs","table","list"],emoji_options:{range:0,range_limit:48,list:[],list_now:[]},initialized:!1,editor_listening:!1,conversation:!1,is_busy:!1,chat_open:!1,real_time:!1,agent_id:-1,agent_online:!1,user_online:!1,expanded:!1,start_header:!1,desktop_notifications:!1,flash_notifications:!1,datetime_last_message:"2000-01-01 00:00:00",datetime_last_message_conversation:"2000-01-01 00:00:00",audio:!1,tab_active:!0,notifications:[],slimscroll_settings:{railVisible:!0,size:"4px",alwaysVisible:!0},scroll_settings:{scroll:9,position:""},typing_settings:{typing:!1,sent:!1,timeout:!1},follow_sent:!1,email_sent:!1,dialogflow_token:0==e("dialogflow-token")?-1:e("dialogflow-token"),timetable:!0,dashboard:!1,articles:!1,main_header:!0,slack_unarchive:[],sendMessage:function(e=-1,s="",a=[]){if(0!=x.conversation){if(-1==e&&(e=l?SB_CURRENT_AGENT.id:i().id),""==s&&0==a.length&&(t(d).find(".sb-attachments > div").each(function(){a.push([t(this).attr("data-name"),t(this).attr("data-url")])}),s=t(d).find("textarea").val().trim()),""!=s||a.length){let n=0!=this.conversation.getLastMessage()?l?1:2:-1,o=e!=p["bot-id"];this.busy(!0),v.ajax({function:"send-message",user_id:e,conversation_id:this.conversation.id,message:s,attachments:a,conversation_status:n},r=>{t(d).find("textarea").val("").css("height",""),t(d).find(".sb-attachments").html(""),(l&&!this.user_online||!l&&!this.agent_online)&&this.update(),!this.follow_sent&&!l&&o&&p.follow&&this.followUp(),!this.email_sent&&o&&(!l&&p["notify-agent-email"]||l&&p["notify-user-email"]&&""!=i().get("email"))&&v.ajax({function:"create-email",recipient_id:l?i().id:0!=this.lastAgent(!1)?this.lastAgent(!1).user_id:-1,sender_name:l?SB_CURRENT_AGENT.full_name:i().get("full_name"),sender_profile_image:l?SB_CURRENT_AGENT.profile_image:i().get("profile_image"),message:s,attachments:a},()=>{this.email_sent=!0}),!0===r&&(o&&this.sendBotMessage(s),!l&&o&&"visitor"==i().get("user_type")?v.ajax({function:"update-user-to-lead",user_id:e},()=>{i().set("user_type","lead"),p["slack-active"]&&this.slackMessage(e,i().get("full_name"),i().get("profile_image"),s,a)}):p["slack-active"]&&this.slackMessage(i().id,o?i().get("full_name"):p["bot-name"],o?i().get("profile_image"):p["bot-image"],s,a),this.timetable&&o&&!l&&p.timetable&&!p["office-hours"]&&setTimeout(()=>{0!=this.conversation&&(this.sendMessage(p["bot-id"],"[timetable]"),this.scrollBottom(),this.timetable=!1)},5e3),!this.articles||l||!p.articles||p["office-hours"]||p["init-dashboard"]||setTimeout(()=>{0!=this.conversation&&(this.sendMessage(p["bot-id"],"[articles]"),this.scrollBottom(),this.articles=!1)},5e3)),t(document).trigger("SBMessageSent",{conversation_id:this.conversation.id,conversation_status:n,message:s,attachments:a}),this.busy(!1)})}}else x.newConversation(l?1:2,e,s,a)},sendBotMessage:function(t){!p["dialogflow-active"]||l||p["bot-office-hours"]&&p["office-hours"]||setTimeout(()=>{v.ajax({function:"send-bot-message",conversation_id:this.conversation.id,message:t,token:this.dialogflow_token},t=>{if("success-bot"==t.status&&(this.dialogflow_token!=t.token&&(this.dialogflow_token=t.token,e("dialogflow-token",t.token)),p["slack-active"]&&"messages"in t&&Array.isArray(t.messages)))for(var s=0;s<t.messages.length;s++)this.slackMessage(i().id,p["bot-name"],p["bot-image"],t.messages[s].message,t.messages[s].attachments)})},p["bot-delay"])},initChat:function(){l||!p.popup||e("popup")||this.popup(),l||!p.privacy||p["registration-required"]||e("privacy-approved")?("undefined"!=typeof Notification&&("all"==p["desktop-notifications"]||!l&&"users"==p["desktop-notifications"]||l&&"agents"==p["desktop-notifications"])&&(this.desktop_notifications=!0),("all"==p["flash-notifications"]||!l&&"users"==p["flash-notifications"]||l&&"agents"==p["flash-notifications"])&&(this.flash_notifications=!0),function(t=!1,s){v.ajax({function:"get-active-user",storage:e("login"),db:t},t=>{if(!t)return s(),!1;"user_type"in t&&(!l&&v.isAgent(t.user_type)?v.error("You are logged in as both agent and user. Logout and use another browser, Incognito Mode to login as user","SBChat.getCurrentUser"):(i(new _(t)),s()))})}(!0,()=>{let a=!1!==i(),n=!!a&&i().get("user_type");!p["registration-required"]||a&&"visitor"!=n&&"lead"!=n?(!p["visitors-registration"]&&!p.welcome||a?0==this.conversation&&a?this.populateConversations():this.finalizeInit():v.ajax({function:"add-user-and-login"},t=>{e("login",t[1]),i(new _(t[0])),this.welcome(),this.finalizeInit()}),p["header-name"]&&a&&"user"==n&&t(u).find(".sb-title").html(`${s("Hello")} ${i().get("full_name")}!`),a&&this.welcome(),setInterval(()=>{this.updateConversations(),this.updateUsersActivity()},1e4),this.setScroll(),this.scrollBottom(!0)):this.registration()})):this.privacy()},finalizeInit:function(){this.initialized||(t(a).attr("style",""),v.ajax({function:"current-url",url:window.location.href}),l||p["init-dashboard"]&&this.showDashboard(),this.initialized=!0)},openChat:function(){this.initialized&&(this.populate(),this.headerAgent(),this.updateUsersActivity(),this.startRealTime(),this.chat_open=!0,this.popup("close"),0!=this.conversation&&0!=this.conversation.get("conversation_status_code")&&this.updateNotifications("remove",this.conversation.id),t(a).sbActivate())},openButton:function(){this.chat_open=t(a).hasClass("sb-active"),this.chat_open?(t(a).sbActivate(!1),this.stopRealTime(),this.chat_open=!1):this.openChat()},openConversation:function(t){i().getFullConversation(t,e=>{this.setConversation(e),this.populate(),this.hideDashboard(),this.main_header=!1,this.chat_open&&0!=e.get("conversation_status_code")&&this.updateNotifications("remove",t)})},update:function(){if(0!=this.conversation){let e=this.conversation.getLastMessage();v.ajax({function:"get-new-messages",conversation_id:this.conversation.id,datetime:this.datetime_last_message_conversation},i=>{if(0!=this.conversation&&Array.isArray(i)&&i.length>0&&(!e||e.id!=i[0].id||e.get("message")!=i[0].message)){let e="",n=[];for(var a=0;a<i.length;a++){let s=new y(i[a]);if(this.datetime_last_message_conversation=s.get("creation_time"),"boolean"!=typeof s.payload()&&"event"in s.payload()&&"delete-message"==s.payload().event){!1!==this.conversation.getMessage(s.id)&&this.deleteMessage(s.id);break}0==this.conversation.getMessage(i[a].id)?(this.conversation.addMessages(s),e+=s.getCode()):(this.conversation.updateMessage(s.id,s),t(c).find(`[data-id="${s.id}"]`).replaceWith(s.getCode())),n.push(s)}t(c).append(e);let o=this.conversation.getLastMessage(),r=o.get("user_type");!l&&this.chat_open&&v.isAgent(r)&&"bot"!=r&&(-1==o.get("message").indexOf("sb-rich-success")&&this.setConversationStatus(0),p.follow&&clearTimeout(m),p["dialogflow-active"]=!1),this.headerAgent(),this.scrollBottom(),setTimeout(function(){t(h).removeClass("sb-status-typing").addClass("sb-status-online").html(s("Online"))},500),t(document).trigger("SBChatNewMessages",{messages:n})}})}},updateConversations:function(){0!=i()&&v.ajax({function:"get-new-user-conversations",datetime:this.datetime_last_message},e=>{if(e.length){this.datetime_last_message=e[0].creation_time;for(var n=0;n<e.length;n++){let t=e[n].conversation_id,a=new y(e[n]),o=v.isAgent(e[n].user_type)?1:0,l=new w([a],{id:t,conversation_status_code:o});if(i().addConversation(l),0==this.conversation&&(this.conversation=l),this.conversation.set("conversation_status_code",o),e[n].user_id==i().id||0!=this.conversation&&this.conversation.id==t&&this.chat_open||(this.updateNotifications("add",t),p["auto-open"]&&this.openChat()),!this.tab_active){if(this.desktop_notifications)if("granted"!==Notification.permission)Notification.requestPermission();else{new Notification(a.get("full_name"),{body:a.get("message"),icon:a.get("profile_image")}).onclick=(()=>{x.openChat(),window.focus()})}this.flash_notifications&&(document.title=s("New message ..."))}}!p["chat-sound"]||this.chat_open&&this.tab_active||this.audio.play(),t(a).find(".sb-user-conversations").html(i().getConversationsCode())}})},populate:function(){if(0!=this.conversation){let s="";for(var e=0;e<this.conversation.messages.length;e++)s+=this.conversation.messages[e].getCode();t(c).html(s),this.scrollBottom(),t(document).trigger("SBChatPopulateComplete",this.conversation)}else 0==i()||i().isConversationsEmpty()||this.showDashboard()},populateConversations:function(){i().getConversations(e=>{let s=e.length;if(s){this.datetime_last_message=e[0].messages[0].get("creation_time");for(var n=0;n<s;n++)1==e[n].get("conversation_status_code")&&this.updateNotifications("add",e[n].id);t(a).removeClass("sb-no-conversations"),t(a).find(".sb-user-conversations").html(i().getConversationsCode())}this.initialized||1!=s||p["init-dashboard"]||this.openConversation(i().conversations[0].id),this.finalizeInit()})},newConversation:function(s,a=-1,n="",o=[]){0!=i()?v.ajax({function:"new-conversation",status_code:s},l=>{if("user-not-found"==l)return void v.ajax({function:"add-user-and-login"},t=>{e("login",t[1]),i(new _(t[0])),this.newConversation(s,a,n,o)});let r=new w([],l.details);this.setConversation(r),this.sendMessage(a,n,o),t(document).trigger("SBChatNewConversationCreated",r)}):v.error("currentUser() not setted","SBChat.newConversation")},setConversation:function(t){t instanceof w?(this.conversation=t,this.datetime_last_message_conversation=0==this.conversation.getLastMessage()?"2000-01-01 00:00:00":this.conversation.getLastMessage().get("creation_time")):v.error("Value not of type SBConversation","SBChat.setConversation")},startRealTime:function(){this.stopRealTime(),this.real_time=setInterval(()=>{(!l||l&&this.user_online)&&this.update(),this.typing(l?0!=i()?i().id:-1:this.agent_id,"check")},1e3)},stopRealTime:function(){clearInterval(this.real_time)},updateUsersActivity:function(){0!=i()&&v.updateUsersActivity(i().id,this.agent_id,e=>{this.typing_settings.typing||("online"==e||this.agent_id==p["bot-id"]?(t(h).addClass("sb-status-online").html(s("Online")),this.agent_online=!0):(t(h).removeClass("sb-status-online").html(s("Away")),this.agent_online=!1))})},busy:function(e){t(d).find(".sb-loader").sbActivate(e),this.is_busy=e},initEditorBoxes:function(){v.ajax({function:"saved-replies"},e=>{if(Array.isArray(e)){let a="";if(e.length>0&&""!=e[0]["reply-name"]){this.replies_list=e;for(var i=0;i<e.length;i++)a+=`<li><div>${e[i]["reply-name"]}</div><div>${e[i]["reply-text"]}</div></li>`}else a=`<p class="sb-no-results">${s("No saved replies found. Add new replies from the Settings area.")}</p>`;t(g).find(".sb-replies-list > ul").html(a)}})},headerAgent:function(){if(!l&&0!=this.conversation&&(-1==this.agent_id||v.isAgent(this.conversation.getLastMessage().get("user_type"))&&this.conversation.getLastMessage().get("user_id")!=this.agent_id)){let e=this.lastAgent();0!=e&&(this.agent_id=e.user_id,0==this.start_header&&(this.start_header=[t(u).html(),t(u).attr("class")]),t(u).addClass("sb-header-agent").removeClass("sb-header-main sb-header-brand").attr("data-agent-id",this.agent_id).html(`<div class="sb-dashboard-btn sb-icon-arrow-left"></div><div class="sb-profile"><img src="${e.profile_image}" /><div><span class="sb-name">${e.full_name}</span><span class="sb-status">${s("Away")}</span></div></div>`),h=t(u).find(".sb-status"),this.dashboard=!1,this.main_header=!1,this.updateUsersActivity(),this.setScroll())}},lastAgent:function(t=!0){let e=!1;if(0!=this.conversation)for(var s=this.conversation.messages.length-1;s>-1;s--){let i=this.conversation.messages[s].get("user_type");if(v.isAgent(i)&&(t||!t&&"bot"!=i)){e={user_id:this.conversation.messages[s].get("user_id"),full_name:this.conversation.messages[s].get("full_name"),profile_image:this.conversation.messages[s].get("profile_image")};break}}return e},setScroll:function(){let e=t(a).find(".sb-chat-scroll"),s=t(window).height()-130-(this.dashboard?0:100);s>600&&(s=600),s<250&&(s=250),t(e).attr("data-height")!=s&&(this.slimscroll_settings.height=s,t(e).attr("data-height",s).slimScroll(this.slimscroll_settings))},scrollBottom:function(e=!1){l?t(c).scrollTop(e?0:t(c)[0].scrollHeight):setTimeout(()=>{t(c).parent().slimScroll({scrollTo:e?"0px":"99999px"}),e&&this.scrollHeader(0)},20)},scrollHeader:function(e){if(this.main_header||0==e){let s=this.scroll_settings.scroll,i=t(u).find(" > .sb-content");"bottom"!=this.scroll_settings.position?(0<=s&&e<0||s<10&&e>0)&&(s+=e>0?1:-1,this.scroll_settings.scroll=s,t(i).css({opacity:s/10-(10==s?0:.5),top:-10*(10-s)+"px"})):s<8&&t(i).css("opacity",0),"top"!=this.scroll_settings.position&&0!=e||(t(i).css({opacity:1,top:0}),this.scroll_settings.scroll=9,this.scroll_settings.position="top")}},showDashboard:function(){l||(t(a).addClass("sb-dashboard-active"),t(u).removeClass("sb-header-agent sb-header-panel"),0!=this.start_header&&t(u).html(this.start_header[0]).addClass(this.start_header[1]),t(a).find(".sb-chat-scroll > div").sbActivate(!1),t(a).find(".sb-dashboard").sbActivate(),this.populateConversations(),this.conversation=!1,this.agent_id=-1,this.stopRealTime(),this.dashboard=!0,this.main_header=!0,this.setScroll(),this.scrollBottom(!0))},hideDashboard:function(){l||(t(c).sbActivate(),t(a).removeClass("sb-dashboard-active").find(".sb-dashboard").sbActivate(!1),this.headerAgent(),this.setScroll(),this.scrollHeader(0),this.dashboard=!1,this.chat_open&&this.startRealTime())},showPanel:function(e,i){let n=t(a).find(".sb-chat-scroll > .sb-panel-"+e);n.length&&(t(a).find(".sb-chat-scroll > div").sbActivate(!1),t(n).sbActivate(),0==this.start_header&&(this.start_header=[t(u).html(),t(u).attr("class")]),t(u).attr("class","sb-header sb-header-panel").html(`${s(i)}<div class="sb-dashboard-btn sb-icon-close"></div>`),this.dashboard=!0)},clear:function(){this.conversation=!1,t(c).html("")},updateNotifications:function(e="add",s){if("add"!=e||this.notifications.includes(s)||this.notifications.push(s),"remove"==e)for(var i=0;i<this.notifications.length;i++)if(this.notifications[i]==s){this.notifications.splice(i,1),this.setConversationStatus(0);break}let n=this.notifications.length;t(a).find(".sb-chat-btn span").attr("data-count",n).html(n>-1?n:0)},setConversationStatus:function(t){v.ajax({function:"update-conversation-status",conversation_id:this.conversation.id,status:t},()=>{this.conversation.set("conversation_status_code",t)})},typing:function(e,i="check"){0!=this.conversation&&("check"==i&&-1!=e&&e!=p["bot-id"]&&(this.agent_online||l&&this.user_online)&&v.ajax({function:"is-typing",user_id:e,conversation_id:this.conversation.id},e=>{e&&!this.typing_settings.typing?(l||t(h).addClass("sb-status-typing").html(s("Typing")),this.typing_settings.typing=!0,t(document).trigger("SBTyping",!0)):!e&&this.typing_settings.typing&&(l||t(h).removeClass("sb-status-typing").addClass("sb-status-online").html(s("Online")),this.typing_settings.typing=!1,t(document).trigger("SBTyping",!1))}),"set"==i&&(this.typing_settings.sent?(clearTimeout(this.typing_settings.timeout),this.typing_settings.timeout=setTimeout(()=>{v.ajax({function:"set-typing",user_id:e,conversation_id:-1},()=>{this.typing_settings.sent=!1})},2e3)):(this.typing_settings.sent=!0,v.ajax({function:"set-typing",user_id:e,conversation_id:this.conversation.id}),this.typing(e,"set"))))},showArticles:function(e=-1){let i=t(a).find(".sb-chat-scroll > .sb-panel-articles"),n="";t(i).html("").sbLoading(!0),this.showPanel("articles",""==p["articles-title"]?"Help Center":p["articles-title"]),this.getArticles(e,a=>{if(-1==e){for(var o=0;o<a.length;o++)n+=`<div data-id="${a[o].id}"><div>${a[o].title}</div><span>${a[o].content}</span></div>`;t(i).html(`<div class="sb-articles">${n}</div>`)}else!1!==a&&t(i).html(`<div data-id="${a.id}" class="sb-article"><div class="sb-title">${a.title}</div><div class="sb-content">${a.content}</div>${""==a.link?"":`<a href="${a.link}" target="_blank" class="sb-btn-text"><i class="sb-icon-plane"></i>${s("Read more")}</a>`}</div>`);t(i).sbLoading(!1)})},getArticles:function(t=-1,e=!1){if(!1===this.articles||-1!=t)v.ajax({function:"get-articles",id:t},s=>{if(-1==t&&(this.articles=s),!1===e)return s;e(s)});else{if(!1===e)return this.articles;e(this.articles)}},searchArticles:function(e,i){""!=e&&(t(i).sbLoading(!0),v.ajax({function:"search-articles",search:e},e=>{let n="";if(0==e.length)n+=`<p class="sb-no-results">${s("No articles found.")}</p>`;else for(var o=0;o<e.length;o++)n+=`<div data-id="${e[o].id}"><div>${e[o].title}</div><span>${e[o].content}</span></div>`;t(a).find(".sb-dashboard-articles .sb-articles").html(n),t(i).sbLoading(!1)}))},categoryEmoji:function(t){let e=this.emoji_options.list;if("all"==t)this.emoji_options.list_now=e;else{this.emoji_options.list_now=[];for(var s=0;s<e.length;s++)e[s].category.startsWith(t)&&this.emoji_options.list_now.push(e[s])}this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()},mouseWheelEmoji:function(e){let s=this.emoji_options.range;e.originalEvent.wheelDelta>0?s-=s<1?0:1:s+=s>this.emoji_options.range_limit?0:1,t(f).find(".sb-emoji-bar > div").sbActivate(!1).eq(s).sbActivate(),this.emoji_options.range=s,this.populateEmoji(s)},insertEmoji:function(e){this.insertText(e),t(f).sbTogglePopup()},showEmoji:function(e){t(f).sbTogglePopup(e)&&(""==t(f).find(".sb-emoji-list > ul").html()&&jQuery.ajax({method:"POST",url:SB_AJAX_URL,data:{function:"emoji"}}).done(t=>{this.emoji_options.list=JSON.parse(t),this.emoji_options.list_now=this.emoji_options.list,this.populateEmoji(0),this.populateEmojiBar()}),v.deselectAll())},populateEmoji:function(e){let s="",i=64*e+64,a=this.emoji_options.list_now;i>a.length&&(i=a.length),this.emoji_options.range_limit=a.length/64-1,this.emoji_options.range=e;for(var n=64*e;n<i;n++)s+=`<li>${a[n].char}</li>`;t(f).find(".sb-emoji-list").html(`<ul>${s}</ul>`)},populateEmojiBar:function(){let e='<div class="sb-active"></div>';for(var s=0;s<this.emoji_options.list_now.length/64-1;s++)e+="<div></div>";this.emoji_options.range=0,t(f).find(".sb-emoji-bar").html(e)},clickEmojiBar:function(e){let s=t(e).index();this.populateEmoji(s),this.emoji_options.range=s,t(f).find(".sb-emoji-bar > div").sbActivate(!1).eq(s).sbActivate()},searchEmoji:function(t){v.search(t,()=>{if(t.length>1){let s=this.emoji_options.list,i=[];for(var e=0;e<s.length;e++)(s[e].category.toLowerCase().indexOf(t)>-1||s[e].name.toLowerCase().indexOf(t)>-1)&&i.push(s[e]);this.emoji_options.list_now=i}else this.emoji_options.list_now=this.emoji_options.list;this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()})},insertContent:function(e){this.insertText(e),v.deactivateAll(),t(n).removeClass("sb-popup-active")},showBox:function(e){t(g).sbTogglePopup(e),v.deselectAll()},searchReplies:function(e){v.search(e,()=>{let s="",i=!(e.length>1);for(var a=0;a<this.replies_list.length;a++)(i||this.replies_list[a]["reply-name"].toLowerCase().indexOf(e)>-1||this.replies_list[a]["reply-text"].toLowerCase().indexOf(e)>-1)&&(s+=`<li><div>${this.replies_list[a]["reply-name"]}</div><div>${this.replies_list[a]["reply-text"]}</div></li>`);t(g).find(".sb-replies-list > ul").html(s)})},textareaChange:function(e){let s=t(e).val(),a=s.charAt(e.selectionStart-1);if("#"==a&&(this.editor_listening=!0),this.editor_listening&&" "==a){let i=s.substr(s.lastIndexOf("#")+1).replace(" ","");this.editor_listening=!1;for(var n=0;n<this.replies_list.length;n++)if(this.replies_list[n]["reply-name"]==i)return void t(e).val(s.substr(0,s.lastIndexOf("#"))+this.replies_list[n]["reply-text"])}""!=s&&this.typing(l?SB_CURRENT_AGENT.id:i().id,"set")},insertText:function(e){let s=t(d).find("textarea").get(0),i=0;if("selectionStart"in s)i=s.selectionStart;else if("selection"in document){s.focus();let t=document.selection.createRange();var a=document.selection.createRange().text.length;t.moveStart("character",-s.value.length),i=t.text.length-a}t(s).val(t(s).val().substr(0,i)+e+t(s).val().substr(i)),t(s).focus(),t(s).manualExpandTextarea()},enabledAutoExpand:function(){t(d).find("textarea").autoExpandTextarea()},privacy:function(){v.ajax({function:"get-block-setting",value:"privacy"},e=>{t(a).find(".sb-chat-scroll").append(`<div class="sb-privacy sb-init-form" data-decline="${e.decline.replace(/"/g,"")}"><div class="sb-title">${e.title}</div><div class="sb-text">${e.message}</div>`+(""!=e.link?`<a target="_blank" href="${e.link}">${e.link.replace("http://","").replace("https://","").replace("www.","")}</a>`:"")+`<div class="sb-buttons"><a class="sb-btn sb-approve">${e["btn-approve"]}</a><a class="sb-btn sb-decline">${e["btn-decline"]}</a></div></div>`),this.finalizeInit()}),this.dashboard=!0,t(a).addClass("sb-init-form-active"),x.setScroll()},popup:function(i=""){"close"!=i?v.ajax({function:"get-block-setting",value:"popup"},e=>{t(a).append('<div class="sb-popup-message">'+(""!=e.title?`<div class="sb-top">${s(e.title)}</div>`:"")+`<div class="sb-text">${s(e.message)}</div><div class="sb-icon-close"></div></div>`)}):t(a).find(".sb-popup-message").length&&(e("popup",!0),t(a).find(".sb-popup-message").remove())},followUp:function(){l||0==i()||""!=i().get("email")||(0!=m&&clearTimeout(m),m=setTimeout(()=>{0!=x.conversation&&(x.sendMessage(p["bot-id"],"[email]"),this.scrollBottom(),this.follow_sent=!0)},5e3))},welcome:function(){p.welcome&&!e("welcome")&&0!=i()&&v.ajax({function:"get-block-setting",value:"welcome"},t=>{x.newConversation(3,p["bot-id"],t.message),setTimeout(()=>{t.open&&this.openChat(),t.sound&&this.audio.play()},2e3),e("welcome",!0)})},slackMessage:function(t,e,s,i,a=[]){let n=this.conversation.id;v.ajax({function:"send-slack-message",user_id:t,full_name:e,profile_image:s,conversation_id:n,message:i,attachments:a},t=>{!0!==t&&v.error(JSON.stringify(t),"send-slack-message")})},deleteMessage:function(e){v.ajax({function:"delete-message",message_id:e},()=>{this.conversation.deleteMessage(e),t(c).find(`[data-id="${e}"]`).remove(),t(document).trigger("SBMessageDeleted",e)})},registration:function(){t(a).find(".sb-chat-scroll").append(C.generate({},"registration","sb-init-form")),this.dashboard=!0,this.finalizeInit(),t(a).addClass("sb-init-form-active"),x.setScroll()}};window.SBChat=x;var C={rich_messsages:{buttons:'<div class="sb-buttons">[options]</div>',select:'<div class="sb-select"><p></p><ul>[options]</ul></div>',list:'<div class="sb-text-list">[values]</div>',table:"<table><tbody>[header][values]</tbody></table>",inputs:'<div class="sb-form">[values]</div>',rating:`<div class="sb-rating"><div class="sb-input sb-input-textarea"><textarea></textarea></div><div><div data-rating="positive" class="sb-submit"><i class="sb-icon-like"></i>${s("Good")}</div><div data-rating="negative" class="sb-submit"><i class="sb-icon-dislike"></i>${s("Bad")}</div></div></div>`},cache:{},generate:function(e,i,n=""){let o,l="",r=!0,c="id"in e?e.id:v.random();if(i in this.rich_messsages)o=this.rich_messsages[i];else if(i in this.cache)o=this.cache[i];else{if(!p["rich-messages"].includes(i))return!1;o='<div class="sb-rich-loading sb-loading"></div>',v.ajax({function:"get-rich-message",name:i},e=>{e=this.initInputs(e),"timetable"==i&&(e=this.timetable(e)),t(a).find(`.sb-rich-message[id="${c}"]`).html(`<div class="sb-content">${e}</div>`),this.cache[i]=e,x.scrollBottom(!!x.dashboard)}),r=!1}if(r){l="success"in e;let a=o.match(/\[.+?\]/g)||[];for(var d=0;d<a.length;d++){let n,l,r=a[d].slice(1,-1);if(r in e){switch(n="",l=e[r].split(","),r){case"options":for(h=0;h<l.length;h++)n+="select"==i?`<li data-value="${v.stringToSlug(l[h])}">${l[h]}</li>`:`<div class="sb-btn sb-submit">${l[h]}</div>`;break;case"values":let a="list"==i,c=a&&l.length&&l[0].indexOf(":")>0;c||(o=o.replace("sb-text-list","sb-text-list sb-text-list-single"));for(h=0;h<l.length;h++)if(c)n+=`<div><div>${l[h].split(":")[0]}</div><div>${l[h].split(":")[1]}</div></div>`;else if(a)n+=`<div>${t.trim(l[h])}</div>`;else if("table"==i){let t=l[h].split(":");n+="<tr>";for(var u=0;u<t.length;u++)n+=`<td>${t[u]}</td>`;n+="</tr>"}else"inputs"==i&&(n+=`<div id="${v.stringToSlug(l[h])}" data-type="text" class="sb-input sb-input-text"><span>${l[h]}</span><input autocomplete="false" type="text" required></div>`);"inputs"==i&&(n+='<div class="sb-btn sb-submit">'+s("button"in e?e.button:"Send now")+"</div>");break;case"header":n+="<tr>";for(var h=0;h<l.length;h++)n+=`<th>${l[h]}</th>`;n+="</tr>";break;default:n=e[r]}o=o.replace(a[d],n)}}}return`<div id="${c}" data-type="${i}" class="sb-rich-message sb-rich-${i} ${n}">`+("title"in e?`<div class="sb-top">${s(e.title)}</div>`:"")+("message"in e?`<div class="sb-text">${s(e.message)}</div>`:"")+`<div class="sb-content">${o}</div>`+(l?`<div data-success="${e.success.replace(/"/g,"")}" class="sb-info"></div>`:"")+"</div>"},submit:function(n,o,r){if(!l&&!t(r).sbLoading()&&!this.is_busy){let l="",d="",u={},h=t(n).find("[data-success]").length?t(n).find("[data-success]").attr("data-success"):"",g=t(n).closest(".sb-rich-message").attr("id"),f=t(n).closest("[data-id]").attr("data-id"),m="",b={"rich-messages":{}},y={profile_image:["",""],first_name:["",""],last_name:["",""],email:["",""],password:["",""],user_type:["",""]},w={},C=r,k="";if(v.null(f))f=-1;else{let t=x.conversation.getMessage(f);m=t.get("message"),"rich-messages"in(b=t.payload())||(b["rich-messages"]={})}switch(!t(r).hasClass("sb-btn")&&t(r).hasClass("sb-select")&&(C=t(r).closest(".sb-btn,.sb-select")),t(C).sbLoading(!0),t(n).find(".sb-info").html("").sbActivate(!1),o){case"email":"first_name"in(w=$.getAll(n))&&(y.user_type=["user",""]),t.extend(y,w),l="Please insert a valid email."+("first_name"in w?"":" All fields are required."),h=`${s(""==h?"Your email is":h)} *${y.email[0]}*`,b["rich-messages"][g]={type:o,result:w},b.event="update-user",u={function:"update-user-and-message",settings:y,payload:b},k="email-complete";break;case"select":case"buttons":w=t(r).html(),h=`${s(""==h?"Your selected the option":h)} *${w}*`,b["rich-messages"][g]={type:o,result:w},u={function:"update-message",payload:b},k=w;break;case"inputs":w=$.getAll(n),h=`${s(""==h?"You inserted the values below.":h)} [list values="`,l="All fields are required.";for(var c in w)h+=`${w[c][1]}:${w[c][0]},`;h=h.slice(0,-1)+'"]',b["rich-messages"][g]={type:o,result:w},u={function:"update-message",payload:b},k="inputs-complete";break;case"registration":let e=$.getAll(n.find(".sb-form-extra")),a=t.extend({},y,e);t.extend(y,$.getAll(n.find(".sb-form-main"))),h=`${s(""==h?"Your account details are the following.":h)} [list values="`;for(var c in y){let t=y[c][0].replace(/:/g,"");""!=t&&("profile_image"==c&&(t=t.substr(t.lastIndexOf("/")+1)),"password"==c&&(t="********",a[c]="********"),h+=`${y[c][1].replace(/:/g,"")}:${t},`)}for(var c in e)""!=e[c][0]&&(h+=`${e[c][1]}:${e[c][0]},`);y.user_type=["user",""],h=h.slice(0,-1)+'"]',b["rich-messages"][g]={type:o,result:a},b.event="update-user",u={function:0!=i()?"update-user-and-message":"add-user-and-login",settings:y,settings_extra:e,payload:b},l=n.find("#password").length?"Please insert your name, last name, a valid email and a password of min 8 chars.":"Please insert your name, last name and a valid email.",k="registration-complete";break;case"rating":let d=t(r).attr("data-rating");h=`${s("Your rating is")} *${s(d)}*. ${s(""==h?"Thank you for your feedback!":h)}`,w={conversation_id:x.conversation.id,agent_id:x.agent_id,user_id:i().id,message:n.find("textarea").val(),rating:"positive"==d?1:-1},b["rich-messages"][g]={type:o,result:w},u={function:"set-rating",payload:b,settings:w},k=d}if(d=m.substr(m.indexOf("["+o)),d=d.substr(0,d.indexOf("]")+1),""!=l&&$.errors(n))return $.showErrorMessage(n,l),x.scrollBottom(),t(C).sbLoading(!1),!1;-1!=f&&t.extend(u,{message_id:f,message:""!=m?m.replace(d,h):h,payload:b}),v.ajax(u,s=>{if(0!=s&&"duplicate-email"!=s){switch(o){case"email":for(var l in y)i().set(l,y[l][0]);break;case"registration":if(0==i())e("login",s[1]),i(new _(s[0])),t(a).removeClass("sb-init-form-active"),t(n).remove(),x.initChat(),x.sendMessage(p["bot-id"],h);else for(var l in y)i().set(l,y[l][0])}-1==f?t(r).closest(".sb-rich-message").html(h):x.setConversationStatus(2),"email"!=o&&"registration"!=o&&"login"!=o&&x.sendBotMessage(`${g}|${o}|${k}`),p["slack-active"]&&x.slackMessage(i().id,i().get("full_name"),i().get("profile_image"),h)}else{let e="";e="duplicate-email"==s?"This email is already in use. Please use another email.":"Error. Please check you details and try again.",$.showErrorMessage(n,e),t(C).sbLoading(!1)}})}},shortcode:function(e){if(e.indexOf(" ")<0)return[e.slice(1,-1),{}];let s={},i=e.substr(1,e.indexOf(" ")-1),a=(e=e.slice(1,-1).substr(i.length+1)).split('" ');for(var n=0;n<a.length;n++)if(a[n].indexOf("=")>-1){let e=a[n].split("=");s[t.trim(e[0])]=e[1].replace(/"/g,"")}return[i,s]},initInputs:function(e){return e=t.parseHTML("<div>"+e+"</div>"),t(e).find(".sb-input input").each(function(){""!=t(this).val()&&t(this).siblings().addClass("sb-active sb-filled")}),t(e).html()},timetable:function(e){let i=t.parseHTML(`<div>${e}</div>`);return t(i).find("[data-time]").each(function(){let a=t(this).attr("data-time").split("|");e="";for(var n=0;n<a.length;n++){if("closed"==a[n]){e+=s("Closed");break}if(""!=a[n]){let t=parseInt(a[n].split(":")[0]),i=a[n].split(":")[1];t>24&&(t-=24),t<0&&(t=24-t);let o=new Date(`01-01-2000 ${t}:${i} UTC`);e+=o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})+(0==n||2==n?`<span>${s("to")}</span>`:1==n&&""!=a[n+1]?"<br />":"")}}t(i).find(" > div > span").html(`<i class="sb-icon-clock"></i> ${s("Time zone")} ${Intl.DateTimeFormat().resolvedOptions().timeZone}`),t(this).html(e)}),t(i).html()}},$={getAll:function(e){let s={};return t(e).find(".sb-input").each((e,i)=>{s[t(i).attr("id")]=this.get(i)}),s},get:function(e){let s=t(e).data("type"),i=t(e).find(" > span").html();switch(s){case"image":let a=t(e).find(".image").attr("data-url");return[v.null(a)?"":a,i];case"select":return[t(e).find("select").val(),i];default:return[t(e).find("input").val(),i]}},set:function(e,s){if(t(e).length){switch(t(e).data("type")){case"image":""==s?t(e).find(".image").removeAttr("data-url").removeAttr("style"):t(e).find(".image").attr("data-url",s).css("background-image",`url(${s})`);break;case"select":t(e).find("select").val(s);break;default:t(e).find("input").val(s)}return!0}return!1},clear:function(e){t(e).find(".sb-input").each((t,e)=>{this.set(e,"")}),this.set(t(e).find("#user_type"),"user")},errors:function(e){let s=!1;return t(e).find("[required]").each(function(){let e=t(this).attr("type"),i=t(this).val();return""==i?(s=!0,!1):"password"==e&&i.length<8?(s=!0,!1):"email"==e&&(i.indexOf("@")<0||i.indexOf(".")<0)?(s=!0,!1):void 0}),s},showErrorMessage:function(e,i){t(e).find(".sb-info").html(s(i)).sbActivate(),clearTimeout(m),m=setTimeout(function(){t(e).find(".sb-info").sbActivate(!1)},7e3)},showSuccessMessage:function(e,s){t(e).find(".sb-info").remove(),t(e).addClass("sb-success").find(".sb-content").html(`<div class="sb-text">${s}</div>`)}};window.SBForm=$}(jQuery),function(t){t.fn.extend({slimScroll:function(e){var s=t.extend({width:"auto",height:"250px",size:"2px",color:"#222",position:"right",distance:"0px",start:"top",opacity:0,alwaysVisible:!1,disableFadeOut:!1,railVisible:!1,railColor:"#222",railOpacity:.2,railDraggable:!0,railClass:"sb-scroll-rail",barClass:"sb-scroll-bar",wrapperClass:"sb-scroll-cnt",allowPageScroll:!1,wheelStep:20,touchScrollStep:200,borderRadius:"3px",railBorderRadius:"3px"},e);return this.each(function(){function i(e){if(r){var i=0;(e=e||window.event).wheelDelta&&(i=-e.wheelDelta/120),e.detail&&(i=e.detail/3);var n=e.target||e.srcTarget||e.srcElement;t(n).closest("."+s.wrapperClass).is(_.parent())&&a(i,!0),e.preventDefault&&!v&&e.preventDefault(),v||(e.returnValue=!1)}}function a(t,e,i){v=!1;var a=t,n=_.outerHeight()-k.outerHeight();if(e&&(a=parseInt(k.css("top"))+t*parseInt(s.wheelStep)/100*k.outerHeight(),a=Math.min(Math.max(a,0),n),a=t>0?Math.ceil(a):Math.floor(a),k.css({top:a+"px"})),f=parseInt(k.css("top"))/(_.outerHeight()-k.outerHeight()),a=f*(_[0].scrollHeight-_.outerHeight()),i){var r=(a=t)/_[0].scrollHeight*_.outerHeight();r=Math.min(Math.max(r,0),n),k.css({top:r+"px"})}_.scrollTop(a),_.trigger("slimscrolling",~~a),o(),l()}function n(){g=Math.max(_.outerHeight()/_[0].scrollHeight*_.outerHeight(),b),k.css({height:g+"px"});var t=g==_.outerHeight()?"none":"block";k.css({display:t})}function o(){if(n(),clearTimeout(u),f>=~~f){if(v=s.allowPageScroll,p!=f){var t="scrolling";0==f&&(t="top"),1<=~~f&&(t="bottom"),_.trigger("slimscroll",t)}}else v=!1;p=f,g>=_.outerHeight()?v=!0:(k.stop(!0,!0).fadeIn("fast"),s.railVisible&&$.stop(!0,!0).fadeIn("fast"))}function l(){s.alwaysVisible||(u=setTimeout(function(){s.disableFadeOut&&r||c||d||(k.fadeOut("slow"),$.fadeOut("slow"))},1e3))}var r,c,d,u,h,g,f,p,m="<div></div>",b=30,v=!1,_=t(this);if(_.parent().hasClass(s.wrapperClass)){var y=_.scrollTop();if(k=_.siblings("."+s.barClass),$=_.siblings("."+s.railClass),n(),t.isPlainObject(e)){if("height"in e&&"auto"==e.height){_.parent().css("height","auto"),_.css("height","auto");var w=_.parent().parent().height();_.parent().css("height",w),_.css("height",w)}else if("height"in e){var x=e.height;_.parent().css("height",x),_.css("height",x)}if("scrollTo"in e)y=parseInt(s.scrollTo);else if("scrollBy"in e)y+=parseInt(s.scrollBy);else if("destroy"in e)return k.remove(),$.remove(),void _.unwrap();a(y,!1,!0)}}else if(!(t.isPlainObject(e)&&"destroy"in e)){s.height="auto"==s.height?_.parent().height():s.height;var C=t(m).addClass(s.wrapperClass).css({position:"relative",overflow:"hidden",width:s.width,height:s.height});_.css({overflow:"hidden",width:s.width,height:s.height});var $=t(m).addClass(s.railClass).css({width:s.size,height:"100%",position:"absolute",top:0,display:s.alwaysVisible&&s.railVisible?"block":"none","border-radius":s.railBorderRadius,background:s.railColor,opacity:s.railOpacity,zIndex:90}),k=t(m).addClass(s.barClass).css({background:s.color,width:s.size,position:"absolute",top:0,opacity:s.opacity,display:s.alwaysVisible?"block":"none","border-radius":s.borderRadius,BorderRadius:s.borderRadius,MozBorderRadius:s.borderRadius,WebkitBorderRadius:s.borderRadius,zIndex:99}),A="right"==s.position?{right:s.distance}:{left:s.distance};$.css(A),k.css(A),_.wrap(C),_.parent().append(k),_.parent().append($),s.railDraggable&&k.bind("mousedown",function(e){var s,i,n,o=t(document);return d=!0,s=parseFloat(k.css("top")),i=e.pageY,o.bind("mousemove.slimscroll",function(t){n=s+t.pageY-i,k.css("top",n),a(0,k.position().top,!1)}),o.bind("mouseup.slimscroll",function(t){d=!1,l(),o.unbind(".slimscroll")}),!1}).bind("selectstart.slimscroll",function(t){return t.stopPropagation(),t.preventDefault(),!1}),$.hover(function(){o()},function(){l()}),k.hover(function(){c=!0},function(){c=!1}),_.hover(function(){r=!0,o(),l()},function(){r=!1,l()}),_.bind("touchstart",function(t,e){t.originalEvent.touches.length&&(h=t.originalEvent.touches[0].pageY)}),_.bind("touchmove",function(t){v||t.originalEvent.preventDefault(),t.originalEvent.touches.length&&(a((h-t.originalEvent.touches[0].pageY)/s.touchScrollStep,!0),h=t.originalEvent.touches[0].pageY)}),n(),"bottom"===s.start?(k.css({top:_.outerHeight()-k.outerHeight()}),a(0,!0)):"top"!==s.start&&(a(t(s.start).position().top,null,!0),s.alwaysVisible||k.hide()),function(t){window.addEventListener?(t.addEventListener("DOMMouseScroll",i,!1),t.addEventListener("mousewheel",i,!1)):document.attachEvent("onmousewheel",i)}(this)}}),this}}),t.fn.extend({slimscroll:t.fn.slimScroll})}(jQuery),jQuery.fn.extend({manualExpandTextarea:function(){var t=this[0];t.style.height="auto",t.style.maxHeight="30px",window.getComputedStyle(t),t.style.height=t.scrollHeight+"px",t.style.maxHeight="",$(t).trigger("textareaChanged")},autoExpandTextarea:function(){var t=this[0];t.addEventListener("input",function(e){$(t).manualExpandTextarea()},!1)}}),function(){var t=[].slice;String.prototype.autoLink=function(){var e,s,i,a,n,o,l;return o=/(^|[\s\n]|<[A-Za-z]*\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi,0<(n=1<=arguments.length?t.call(arguments,0):[]).length?(a=n[0],e=a.callback,i=function(){var t;for(s in t=[],a)l=a[s],"callback"!==s&&t.push(" "+s+"='"+l+"'");return t}().join(""),this.replace(o,function(t,s,a){return""+s+(("function"==typeof e?e(a):void 0)||"<a href='"+a+"'"+i+">"+a+"</a>")})):this.replace(o,"$1<a href='$2'>$2</a>")}}.call(this);